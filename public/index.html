<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>oblivion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="/void-icon.svg">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #020204;
  --surface: #07070a;
  --surface2: #0d0d11;
  --border: rgba(255,255,255,0.10);
  --border-hi: rgba(255,255,255,0.16);
  --text: #e8e8e8;
  --muted: #666;
  --dim: #444;
  --accent: #c8f0a0;
  --accent-rgb: 200,240,160;
  --font-display: 'DM Serif Display', serif;
  --font-mono: 'DM Mono', monospace;
}

/* ── COLOR SCHEMES ── */
body.scheme-blue   { --accent: #93c5fd; --accent-rgb: 147,197,253; }
body.scheme-purple { --accent: #c4b5fd; --accent-rgb: 196,181,253; }
body.scheme-amber  { --accent: #fcd34d; --accent-rgb: 252,211,77; }
body.scheme-red    { --accent: #fca5a5; --accent-rgb: 252,165,165; }
body.scheme-cyan   { --accent: #67e8f9; --accent-rgb: 103,232,249; }

html, body { height: 100%; overflow: hidden; cursor: none; background: var(--bg); color: var(--text); font-family: var(--font-mono); font-weight: 300; font-size: 13px; }

canvas#bg { position: fixed; inset: 0; z-index: 0; }

#grain-overlay {
  position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.06;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
  background-repeat: repeat; background-size: 180px 180px;
}

.vignette {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.35) 100%);
}

/* ── CURSOR ── */
.cursor-glow {
  position: fixed; width: 280px; height: 280px; border-radius: 50%;
  pointer-events: none; z-index: 99998; transform: translate(-50%,-50%);
  background: radial-gradient(circle, rgba(220,230,255,0.028) 0%, transparent 70%);
  transition: opacity 0.3s; opacity: 0;
}
.cursor-dot {
  position: fixed; width: 6px; height: 6px; border-radius: 50%;
  background: rgba(255,255,255,0.9); pointer-events: none; z-index: 99999;
  transform: translate(-50%,-50%); box-shadow: 0 0 6px rgba(255,255,255,0.4);
  transition: opacity 0.3s; opacity: 0;
}
.cursor-trail {
  position: fixed; border-radius: 50%; pointer-events: none; z-index: 99997;
  transform: translate(-50%,-50%); background: rgba(235,245,220,0.9);
}

/* ── PANIC FLASH ── */
.panic-flash { position: fixed; inset: 0; z-index: 99999; background: #fff; opacity: 0; pointer-events: none; transition: opacity 0.05s; }

/* ── SCREENS ── */
.screen {
  position: fixed; inset: 0; z-index: 1;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s ease;
}
.screen.active { opacity: 1; pointer-events: all; }

/* ── HOME SCREEN ── */
#screen-home {
  justify-content: center;
  padding-bottom: 80px;
}
#screen-home::before {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -58%);
  width: 500px; height: 500px;
  background: radial-gradient(ellipse at center,
    rgba(var(--accent-rgb), 0.04) 0%,
    rgba(var(--accent-rgb), 0.015) 35%,
    transparent 70%);
  pointer-events: none;
  animation: glowPulse 6s ease-in-out infinite;
}
@keyframes glowPulse {
  0%, 100% { opacity: 0.7; transform: translate(-50%, -58%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -58%) scale(1.08); }
}

.wordmark {
  font-family: var(--font-display);
  font-size: clamp(1.8rem, 4vw, 2.8rem);
  color: var(--text); letter-spacing: -0.02em;
  text-shadow:
    0 0 20px rgba(255,255,255,0.35),
    0 0 60px rgba(255,255,255,0.15),
    0 0 140px rgba(200,240,160,0.08);
  margin-bottom: 6px;
  opacity: 0; transform: translateY(10px);
  animation: fadeUp 0.7s ease forwards 0.2s;
}
.tagline {
  font-size: 10px; color: #3a3a42; letter-spacing: 0.18em;
  text-transform: uppercase; margin-bottom: 52px;
  opacity: 0; transform: translateY(8px);
  animation: fadeUp 0.7s ease forwards 0.4s;
  text-shadow: 0 0 20px rgba(200,240,160,0.12);
}
@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

/* App icon grid */
.app-grid {
  display: grid;
  grid-template-columns: repeat(5, 88px);
  gap: 12px;
  opacity: 0; transform: translateY(10px);
  animation: fadeUp 0.7s ease forwards 0.55s;
}

.app-icon {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 9px; cursor: none;
  transition: transform 0.18s ease;
}
.app-icon:hover { transform: translateY(-3px); }
.app-icon:hover .icon-tile {
  border-color: rgba(255,255,255,0.16);
  border-top-color: rgba(255,255,255,0.22);
  background: rgba(255,255,255,0.055);
  box-shadow:
    0 0 28px rgba(var(--accent-rgb),0.14),
    0 0 60px rgba(var(--accent-rgb),0.06),
    0 6px 24px rgba(0,0,0,0.5),
    inset 0 1px 0 rgba(255,255,255,0.1);
  transform: translateY(-1px);
}
.app-icon:hover .icon-tile svg {
  filter: drop-shadow(0 0 6px rgba(var(--accent-rgb),0.5));
}
.app-icon:hover .icon-label { color: #ccc; }

.icon-tile {
  width: 72px; height: 72px; border-radius: 18px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.09);
  border-top-color: rgba(255,255,255,0.15);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.25s ease;
  backdrop-filter: blur(12px);
  box-shadow:
    0 2px 16px rgba(0,0,0,0.5),
    inset 0 1px 0 rgba(255,255,255,0.07),
    0 0 0 0px rgba(var(--accent-rgb),0);
}
.icon-tile svg { width: 30px; height: 30px; }

.icon-label {
  font-size: 10px; color: #555; letter-spacing: 0.06em;
  text-transform: lowercase; transition: color 0.18s;
  text-align: center;
}

/* ── BROWSER APP ── */
#screen-browser {
  flex-direction: column; align-items: stretch;
  justify-content: flex-start; padding-bottom: 60px;
}

.browser-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  background: rgba(6,6,9,0.85);
  backdrop-filter: blur(24px);
  flex-shrink: 0;
  z-index: 10;
  box-shadow: 0 1px 0 rgba(255,255,255,0.04);
  overflow: hidden;
}

/* Chrome-style tabs — + button lives inside, stays glued after last tab */
.browser-tabs {
  display: flex; align-items: center; gap: 0;
  flex: 1; overflow: hidden; min-width: 0;
}

.browser-tab {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 10px 5px 12px;
  height: 30px;
  border-radius: 7px;
  background: transparent;
  border: 1px solid transparent;
  color: #555; font-family: var(--font-mono); font-size: 11px;
  cursor: none;
  flex: 1; min-width: 64px; max-width: 210px;
  transition: flex 0.2s cubic-bezier(0.4,0,0.2,1), max-width 0.2s cubic-bezier(0.4,0,0.2,1), min-width 0.2s cubic-bezier(0.4,0,0.2,1), background 0.15s, color 0.15s, border-color 0.15s, opacity 0.15s, transform 0.2s cubic-bezier(0.4,0,0.2,1);
  position: relative; overflow: hidden;
  transform-origin: left center;
  margin-right: 3px;
}
.browser-tab.tab-entering {
  animation: tabSlideIn 0.2s cubic-bezier(0.4,0,0.2,1) forwards;
}
.browser-tab.tab-leaving {
  animation: tabSlideOut 0.18s cubic-bezier(0.4,0,0.2,1) forwards;
}
@keyframes tabSlideIn {
  from { opacity: 0; transform: scaleX(0.4) translateX(-8px); max-width: 0; min-width: 0; flex: 0; }
  to   { opacity: 1; transform: scaleX(1) translateX(0); }
}
@keyframes tabSlideOut {
  from { opacity: 1; transform: scaleX(1); }
  to   { opacity: 0; transform: scaleX(0.4); max-width: 0; min-width: 0; flex: 0; margin-right: 0; }
}
.browser-tab.active {
  background: rgba(255,255,255,0.06);
  border-color: rgba(255,255,255,0.10);
  color: #ddd;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
}
.browser-tab:hover:not(.active) { color: #999; background: rgba(255,255,255,0.03); }
.browser-tab-title {
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  flex: 1; min-width: 0;
}
.browser-tab-close {
  background: none; border: none; color: #444; font-size: 13px;
  cursor: none; padding: 2px 3px; line-height: 1; transition: color 0.15s;
  flex-shrink: 0; border-radius: 4px; margin-left: 2px;
  opacity: 0; transition: opacity 0.15s, color 0.15s;
}
.browser-tab:hover .browser-tab-close,
.browser-tab.active .browser-tab-close { opacity: 1; }
.browser-tab-close:hover { color: #ccc; background: rgba(255,255,255,0.06); }

/* + sits right after last tab, no gap */
.browser-tab-new {
  background: none; border: none; color: #555; font-size: 17px; line-height: 1;
  cursor: none; padding: 5px 7px; transition: color 0.15s; flex-shrink: 0;
  font-family: var(--font-mono);
}
.browser-tab-new:hover { color: #ccc; }

/* Address bar row */
.browser-addr-row {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  background: rgba(5,5,7,0.6);
  backdrop-filter: blur(20px);
  flex-shrink: 0;
}

.browser-nav-btn {
  background: none; border: none; color: #666; font-size: 14px;
  cursor: none; padding: 4px 6px; transition: color 0.15s; flex-shrink: 0;
  font-family: var(--font-mono); line-height: 1;
}
.browser-nav-btn:hover { color: #bbb; }
.browser-nav-btn:disabled { opacity: 0.25; }

.browser-addr-wrap {
  flex: 1; display: flex; align-items: center;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.10);
  border-radius: 7px; padding: 6px 12px; gap: 8px;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
}
.browser-addr-wrap:focus-within {
  border-color: rgba(var(--accent-rgb),0.3);
  box-shadow: 0 0 0 2px rgba(var(--accent-rgb),0.07), inset 0 1px 0 rgba(255,255,255,0.04);
}
.browser-addr { flex: 1; background: none; border: none; outline: none; color: #ccc; font-family: var(--font-mono); font-size: 12px; }
.browser-addr::placeholder { color: #444; }

.browser-go {
  background: none; border: none; color: #555;
  font-family: var(--font-mono); font-size: 11px; cursor: none;
  transition: color 0.15s; padding: 0 2px;
}
.browser-go:hover { color: var(--accent); }

/* Engine selector */
.engine-select {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 6px; color: #666;
  font-family: var(--font-mono); font-size: 10px;
  padding: 5px 8px; cursor: none; outline: none;
  transition: border-color 0.15s; flex-shrink: 0;
}
.engine-select:focus { border-color: rgba(255,255,255,0.12); }
.engine-select option { background: #0a0a0d; }

/* Browser frame area */
.browser-frames { flex: 1; position: relative; overflow: hidden; }
.browser-frame-slot {
  position: absolute; inset: 0; display: none;
}
.browser-frame-slot.active { display: block; }
.browser-frame-slot iframe {
  width: 100%; height: 100%; border: none;
}

/* New tab page */
.newtab-page {
  width: 100%; height: 100%;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 0; position: relative; user-select: none;
}
.newtab-wordmark {
  font-family: var(--font-display);
  font-size: clamp(2.2rem, 6vw, 4rem);
  color: var(--text);
  letter-spacing: -0.02em;
  text-shadow: 0 0 60px rgba(255,255,255,0.14), 0 0 140px rgba(255,255,255,0.06);
  pointer-events: none;
  transition: opacity 0.35s ease, transform 0.35s ease;
}
.newtab-wordmark.hidden {
  opacity: 0;
  transform: translateY(-12px);
}
.newtab-hint {
  font-size: 11px; color: #3a3a42; letter-spacing: 0.12em;
  margin-top: 18px; text-transform: uppercase;
  transition: opacity 0.35s ease;
  pointer-events: none;
  display: flex; align-items: center; gap: 7px;
}
.newtab-hint.hidden { opacity: 0; }
.newtab-arrow {
  font-size: 14px; color: #444;
  animation: arrowBob 2s ease-in-out infinite;
}
@keyframes arrowBob {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}

/* ── GAMES APP ── */
#screen-games {
  flex-direction: column; align-items: stretch;
  justify-content: flex-start; padding-bottom: 60px;
}

.games-header {
  padding: 18px 20px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
  background: rgba(5,5,7,0.5); backdrop-filter: blur(20px);
}
.games-header-title { font-family: var(--font-display); font-size: 1.1rem; color: rgba(255,255,255,0.75); }
.games-search {
  flex: 1; max-width: 320px; margin-left: auto;
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 7px; padding: 7px 12px;
  color: var(--text); font-family: var(--font-mono); font-size: 11px; outline: none;
  transition: border-color 0.2s;
}
.games-search:focus { border-color: rgba(255,255,255,0.14); }
.games-search::placeholder { color: #444; }
.games-sort-sel {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 6px; color: #777; font-family: var(--font-mono); font-size: 10px;
  padding: 6px 8px; cursor: none; outline: none;
}
.games-sort-sel option { background: #0a0a0d; }

.games-scroll {
  flex: 1; overflow-y: auto; padding: 16px 20px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.05) transparent;
}
.games-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 10px;
  transition: opacity 0.18s;
}
.games-grid.fading { opacity: 0; }

.game-card {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.09);
  border-top-color: rgba(255,255,255,0.13); border-radius: 10px; overflow: hidden;
  cursor: none; transition: border-color 0.18s, transform 0.18s, box-shadow 0.18s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.game-card:hover {
  border-color: rgba(var(--accent-rgb),0.25); transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 16px rgba(var(--accent-rgb),0.06);
}
.game-card img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; background: var(--surface2); }
.game-card-name { padding: 7px 8px 8px; font-size: 10px; color: #777; text-align: center; line-height: 1.3; }
.game-card:hover .game-card-name { color: #ccc; }

.games-loading { text-align: center; color: #444; font-size: 11px; padding: 60px; letter-spacing: 0.1em; text-transform: uppercase; }

/* Game viewer overlay */
.game-viewer {
  position: fixed; inset: 0; z-index: 200;
  display: flex; flex-direction: column;
  background: var(--bg);
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.game-viewer.open { opacity: 1; pointer-events: all; }
.game-viewer-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.04);
  background: rgba(5,5,7,0.8); backdrop-filter: blur(20px);
  flex-shrink: 0;
}
.game-viewer-title { font-size: 12px; color: #bbb; flex: 1; }
.game-viewer-author { font-size: 10px; color: #555; }
.gv-btn {
  background: none; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px;
  color: #777; font-family: var(--font-mono); font-size: 10px;
  padding: 5px 10px; cursor: none; transition: all 0.15s; letter-spacing: 0.05em;
}
.gv-btn:hover { border-color: rgba(255,255,255,0.15); color: #ccc; }
.game-viewer iframe { flex: 1; border: none; width: 100%; }

/* ── SETTINGS APP ── */
#screen-settings {
  flex-direction: column; align-items: center;
  justify-content: flex-start; padding: 40px 20px 80px;
  overflow-y: auto; max-height: 100vh;
}
.settings-inner {
  width: min(520px, 92vw);
}
.settings-app-title {
  font-family: var(--font-display); font-size: 1.4rem;
  color: rgba(255,255,255,0.8); margin-bottom: 32px;
}
.settings-section {
  margin-bottom: 32px;
}
.settings-section-title {
  font-size: 9px; color: #555; letter-spacing: 0.14em;
  text-transform: uppercase; margin-bottom: 12px; padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

/* Background picker */
.bg-options {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
}
.bg-option {
  border-radius: 8px; overflow: hidden; cursor: none;
  border: 1px solid rgba(255,255,255,0.09);
  transition: border-color 0.15s, box-shadow 0.15s; position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.bg-option:hover { border-color: rgba(255,255,255,0.16); }
.bg-option.active {
  border-color: rgba(var(--accent-rgb),0.45);
  box-shadow: 0 0 14px rgba(var(--accent-rgb),0.12);
}
.bg-option canvas { width: 100%; height: 52px; display: block; }
.bg-option-label { font-size: 9px; color: #666; text-align: center; padding: 4px 0 5px; letter-spacing: 0.05em; }
.bg-option.active .bg-option-label { color: var(--accent); }

/* Panic key */
.panic-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.panic-key-display {
  width: 36px; height: 36px; border-radius: 7px;
  background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; color: var(--text); flex-shrink: 0;
}
.panic-set-btn {
  background: none; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px;
  color: #777; font-family: var(--font-mono); font-size: 10px;
  padding: 6px 12px; cursor: none; transition: all 0.15s;
}
.panic-set-btn:hover { border-color: rgba(255,255,255,0.15); color: #bbb; }
.panic-hint { font-size: 9px; color: #555; letter-spacing: 0.05em; line-height: 1.5; }

/* Cloak */
.cloak-label { font-size: 9px; color: #555; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 6px; }
.input-row {
  display: flex; align-items: center; gap: 8px;
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.10);
  border-radius: 7px; padding: 8px 12px; margin-bottom: 10px;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
}
.input-row:focus-within {
  border-color: rgba(var(--accent-rgb),0.3);
  box-shadow: 0 0 0 2px rgba(var(--accent-rgb),0.07), inset 0 1px 0 rgba(255,255,255,0.04);
}
.input-row input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-family: var(--font-mono); font-size: 12px;
}
.input-row input::placeholder { color: #444; }

.cloak-presets {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px;
}
.cloak-preset {
  display: flex; flex-direction: column; align-items: center; gap: 5px;
  padding: 9px 6px; background: rgba(255,255,255,0.02);
  border: 1px solid rgba(255,255,255,0.06); border-radius: 8px;
  color: #666; font-family: var(--font-mono); font-size: 10px;
  cursor: none; transition: all 0.15s; letter-spacing: 0.03em;
}
.cloak-preset img { width: 18px; height: 18px; object-fit: contain; border-radius: 3px; }
.cloak-preset:hover { color: #bbb; border-color: rgba(255,255,255,0.12); }
.cloak-preset.active { background: rgba(200,240,160,0.05); border-color: rgba(200,240,160,0.25); color: var(--accent); }

.action-btn {
  width: 100%; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 7px; color: #777; font-family: var(--font-mono); font-size: 11px;
  padding: 10px; cursor: none; transition: all 0.15s; margin-bottom: 6px; letter-spacing: 0.04em;
}
.action-btn:hover { border-color: rgba(255,255,255,0.14); color: #ccc; }
.action-btn.dim { color: #444; }
.action-btn.dim:hover { color: #888; }

/* Color scheme picker */
.scheme-options {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 7px;
}
.scheme-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 12px; background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.09); border-radius: 8px;
  color: #777; font-family: var(--font-mono); font-size: 10px;
  cursor: none; transition: all 0.15s; letter-spacing: 0.04em;
}
.scheme-btn:hover { border-color: rgba(255,255,255,0.16); color: #bbb; }
.scheme-btn.active {
  border-color: var(--c);
  background: rgba(255,255,255,0.05);
  color: var(--c);
  box-shadow: 0 0 12px color-mix(in srgb, var(--c) 20%, transparent);
}
.scheme-dot {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
}

/* ── PLACEHOLDER APPS ── */
.placeholder-screen {
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
  padding-bottom: 60px;
}
.placeholder-screen svg { opacity: 0.15; }
.placeholder-label { font-size: 11px; color: #555; letter-spacing: 0.12em; }
.placeholder-sub { font-size: 10px; color: #444; letter-spacing: 0.08em; }

/* ── TASKBAR ── */
#taskbar {
  position: fixed; bottom: 18px; left: 50%;
  transform: translateX(-50%) translateY(0);
  z-index: 100;
  display: flex; align-items: center; gap: 4px;
  background: rgba(10,10,14,0.88); backdrop-filter: blur(28px);
  border: 1px solid rgba(255,255,255,0.11);
  border-top-color: rgba(255,255,255,0.17);
  border-radius: 18px; padding: 6px 8px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.03) inset, 0 1px 0 rgba(255,255,255,0.07) inset;
  opacity: 0; animation: taskbarIn 0.7s ease forwards 0.8s;
}
@keyframes taskbarIn {
  from { opacity: 0; transform: translateX(-50%) translateY(12px); }
  to   { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.taskbar-btn {
  display: flex; align-items: center; justify-content: center;
  width: 40px; height: 40px; border-radius: 12px;
  background: none; border: none; cursor: none;
  transition: all 0.15s; position: relative;
  color: #666;
}
.taskbar-btn:hover { background: rgba(255,255,255,0.07); color: #bbb; }
.taskbar-btn.active {
  background: rgba(var(--accent-rgb),0.1);
  color: var(--accent);
  box-shadow: 0 0 14px rgba(var(--accent-rgb),0.12);
}
.taskbar-btn svg { width: 18px; height: 18px; }

/* Active dot under taskbar icon */
.taskbar-btn.active::after {
  content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%);
  width: 4px; height: 4px; border-radius: 50%; background: var(--accent);
  box-shadow: 0 0 6px rgba(var(--accent-rgb),0.7);
}

.taskbar-sep {
  width: 1px; height: 24px; background: rgba(255,255,255,0.08); margin: 0 4px;
}

/* ── TOAST ── */
#toastContainer {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  z-index: 9000; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none;
}
.toast {
  display: flex; align-items: center; gap: 8px; padding: 8px 14px;
  background: rgba(8,8,11,0.92); border: 1px solid rgba(255,255,255,0.05);
  border-top-color: rgba(255,255,255,0.08); border-radius: 8px;
  color: #666; font-family: var(--font-mono); font-size: 11px; letter-spacing: 0.04em;
  backdrop-filter: blur(20px); white-space: nowrap;
  opacity: 0; transform: translateY(6px); transition: opacity 0.2s, transform 0.2s;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.toast.info .toast-dot { background: rgba(200,240,160,0.6); }
.toast.info { color: #888; border-color: rgba(200,240,160,0.08); }
.toast.success .toast-dot { background: var(--accent); box-shadow: 0 0 6px rgba(200,240,160,0.5); }
.toast.success { border-color: rgba(200,240,160,0.18); color: var(--accent); }
.toast.error .toast-dot { background: #f87171; }
.toast.error { border-color: rgba(248,113,113,0.15); color: #f87171; }
</style>
</head>
<body>

<canvas id="bg"></canvas>
<div id="grain-overlay"></div>
<div class="vignette"></div>
<div class="cursor-glow" id="cursorGlow"></div>
<div class="cursor-dot" id="cursorDot"></div>
<div class="panic-flash" id="panicFlash"></div>
<div id="toastContainer"></div>

<!-- ══ HOME SCREEN ══ -->
<div class="screen active" id="screen-home">
  <div class="wordmark">oblivion</div>
  <div class="tagline">between here and nowhere</div>
  <div class="app-grid">

    <div class="app-icon" data-screen="browser">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="15" cy="15" r="11"/>
          <path d="M4 15h22M15 4c-3 4-4.5 7-4.5 11s1.5 7 4.5 11M15 4c3 4 4.5 7 4.5 11s-1.5 7-4.5 11"/>
        </svg>
      </div>
      <span class="icon-label">browser</span>
    </div>

    <div class="app-icon" data-screen="games">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="9" width="24" height="16" rx="4"/>
          <path d="M9 17v-3m0 0v-3m0 3H6m3 0h3"/>
          <circle cx="21" cy="14" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <circle cx="24" cy="17" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <circle cx="18" cy="17" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <circle cx="21" cy="20" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <path d="M10 6l2 3M20 6l-2 3" stroke-width="1.2"/>
        </svg>
      </div>
      <span class="icon-label">games</span>
    </div>

    <div class="app-icon" data-screen="music">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 22V8l14-3v14"/>
          <circle cx="8" cy="22" r="3"/>
          <circle cx="22" cy="19" r="3"/>
        </svg>
      </div>
      <span class="icon-label">music</span>
    </div>

    <div class="app-icon" data-screen="account">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="15" cy="11" r="5"/>
          <path d="M4 26c0-5 5-8 11-8s11 3 11 8"/>
        </svg>
      </div>
      <span class="icon-label">account</span>
    </div>

    <div class="app-icon" data-screen="settings">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h22M4 15h22M4 22h22"/>
          <circle cx="10" cy="8" r="3" fill="rgba(5,5,7,1)" stroke="rgba(255,255,255,0.35)"/>
          <circle cx="20" cy="15" r="3" fill="rgba(5,5,7,1)" stroke="rgba(255,255,255,0.35)"/>
          <circle cx="10" cy="22" r="3" fill="rgba(5,5,7,1)" stroke="rgba(255,255,255,0.35)"/>
        </svg>
      </div>
      <span class="icon-label">settings</span>
    </div>

  </div>
</div>

<!-- ══ BROWSER SCREEN ══ -->
<div class="screen" id="screen-browser">
  <div class="browser-bar">
    <div class="browser-tabs" id="browserTabs">
      <button class="browser-tab-new" id="newTabBtn" title="new tab">+</button>
    </div>
  </div>
  <div class="browser-addr-row">
    <button class="browser-nav-btn" id="navBack" title="back">←</button>
    <button class="browser-nav-btn" id="navForward" title="forward">→</button>
    <button class="browser-nav-btn" id="navRefresh" title="refresh">↺</button>
    <div class="browser-addr-wrap">
      <input class="browser-addr" id="browserAddr" placeholder="search or enter url..." autocomplete="off" spellcheck="false">
      <button class="browser-go" id="browserGo">go</button>
    </div>
    <select class="engine-select" id="engineSelect">
      <option value="https://duckduckgo.com/?q=">DuckDuckGo</option>
      <option value="https://www.google.com/search?q=">Google</option>
      <option value="https://search.brave.com/search?q=">Brave</option>
      <option value="https://www.bing.com/search?q=">Bing</option>
      <option value="https://search.yahoo.com/search?p=">Yahoo</option>
    </select>
  </div>
  <div class="browser-frames" id="browserFrames"></div>
</div>

<!-- ══ GAMES SCREEN ══ -->
<div class="screen" id="screen-games">
  <div class="games-header">
    <div class="games-header-title">games</div>
    <input class="games-search" id="gamesSearch" placeholder="search..." autocomplete="off" spellcheck="false">
    <select class="games-sort-sel" id="gamesSort">
      <option value="name">a–z</option>
      <option value="popular">popular</option>
      <option value="newest">newest</option>
    </select>
  </div>
  <div class="games-scroll">
    <div class="games-grid" id="gamesGrid">
      <div class="games-loading">loading games...</div>
    </div>
  </div>
</div>

<!-- Game viewer overlay -->
<div class="game-viewer" id="gameViewer">
  <div class="game-viewer-bar">
    <div class="game-viewer-title" id="gameViewerTitle">game</div>
    <div class="game-viewer-author" id="gameViewerAuthor"></div>
    <button class="gv-btn" id="gameFullscreen">⛶ fullscreen</button>
    <button class="gv-btn" id="gameNewTab">↗ new tab</button>
    <button class="gv-btn" id="gameClose">✕ close</button>
  </div>
  <iframe id="gameFrame" sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-popups allow-modals" allowfullscreen></iframe>
</div>

<!-- ══ MUSIC SCREEN (placeholder) ══ -->
<div class="screen placeholder-screen" id="screen-music">
  <svg width="64" height="64" viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1.2" stroke-linecap="round">
    <path d="M11 22V8l14-3v14"/><circle cx="8" cy="22" r="3"/><circle cx="22" cy="19" r="3"/>
  </svg>
  <div class="placeholder-label">music</div>
  <div class="placeholder-sub">coming soon</div>
</div>

<!-- ══ ACCOUNT SCREEN (placeholder) ══ -->
<div class="screen placeholder-screen" id="screen-account">
  <svg width="64" height="64" viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1.2" stroke-linecap="round">
    <circle cx="15" cy="11" r="5"/><path d="M4 26c0-5 5-8 11-8s11 3 11 8"/>
  </svg>
  <div class="placeholder-label">account</div>
  <div class="placeholder-sub">coming soon</div>
</div>

<!-- ══ SETTINGS SCREEN ══ -->
<div class="screen" id="screen-settings">
  <div class="settings-inner">
    <div class="settings-app-title">settings</div>

    <div class="settings-section">
      <div class="settings-section-title">background</div>
      <div class="bg-options" id="bgOptions">
        <div class="bg-option" data-bg="particles" id="prev-particles">
          <canvas id="prev-canvas-particles"></canvas>
          <div class="bg-option-label">particles</div>
        </div>
        <div class="bg-option" data-bg="rain" id="prev-rain">
          <canvas id="prev-canvas-rain"></canvas>
          <div class="bg-option-label">rain</div>
        </div>
        <div class="bg-option" data-bg="matrix" id="prev-matrix">
          <canvas id="prev-canvas-matrix"></canvas>
          <div class="bg-option-label">matrix</div>
        </div>
        <div class="bg-option" data-bg="starfield" id="prev-starfield">
          <canvas id="prev-canvas-starfield"></canvas>
          <div class="bg-option-label">starfield</div>
        </div>
        <div class="bg-option" data-bg="dots" id="prev-dots">
          <canvas id="prev-canvas-dots"></canvas>
          <div class="bg-option-label">dots</div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">panic key</div>
      <div class="panic-row">
        <div class="panic-key-display" id="panicKeyDisplay">?</div>
        <button class="panic-set-btn" id="panicSetBtn">press to set key</button>
        <span class="panic-hint">instantly navigates away<br>and clears history</span>
      </div>
      <div class="cloak-label" style="margin-top:10px;">escape url</div>
      <div class="input-row">
        <input id="panicUrl" type="text" placeholder="https://clever.com" autocomplete="off" spellcheck="false">
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">tab cloak</div>
      <div class="cloak-label">tab name</div>
      <div class="input-row"><input id="cloakTitle" type="text" placeholder="e.g. Google Classroom" autocomplete="off" spellcheck="false"></div>
      <div class="cloak-label">favicon preset</div>
      <div class="cloak-presets" id="cloakPresets">
        <button class="cloak-preset" data-title="Google Classroom" data-icon="https://ssl.gstatic.com/classroom/favicon.png"><img src="https://ssl.gstatic.com/classroom/favicon.png" alt=""> classroom</button>
        <button class="cloak-preset" data-title="Google Docs" data-icon="https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico"><img src="https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico" alt=""> docs</button>
        <button class="cloak-preset" data-title="Google Drive" data-icon="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png"><img src="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" alt=""> drive</button>
        <button class="cloak-preset" data-title="Khan Academy" data-icon="/favicons/khan.ico"><img src="/favicons/khan.ico" alt=""> khan</button>
        <button class="cloak-preset" data-title="Quizlet" data-icon="/favicons/quizlet.ico"><img src="/favicons/quizlet.ico" alt=""> quizlet</button>
        <button class="cloak-preset" data-title="Duolingo" data-icon="/favicons/duolingo.ico"><img src="/favicons/duolingo.ico" alt=""> duolingo</button>
        <button class="cloak-preset" data-title="Desmos" data-icon="/favicons/desmos.ico"><img src="/favicons/desmos.ico" alt=""> desmos</button>
        <button class="cloak-preset" data-title="Clever | Portal" data-icon="/favicons/clever.ico"><img src="/favicons/clever.ico" alt=""> clever</button>
        <button class="cloak-preset" data-title="Choose a subject, i-Ready" data-icon="/favicons/iready.ico"><img src="/favicons/iready.ico" alt=""> i-ready</button>
        <button class="cloak-preset" data-title="NoodleTools - Projects" data-icon="/favicons/noodletools.ico"><img src="/favicons/noodletools.ico" alt=""> noodle</button>
        <button class="cloak-preset" data-title="Schoology" data-icon="/favicons/schoology.ico"><img src="/favicons/schoology.ico" alt=""> schoology</button>
        <button class="cloak-preset active" data-title="oblivion" data-icon="/void-icon.svg"><img src="/void-icon.svg" alt=""> oblivion</button>
      </div>
      <div class="cloak-label">custom icon url</div>
      <div class="input-row"><input id="cloakIcon" type="text" placeholder="https://example.com/favicon.ico" autocomplete="off" spellcheck="false"></div>
      <button class="action-btn" id="applyCloak">apply cloak</button>
      <button class="action-btn dim" id="resetCloak">reset to oblivion</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">color scheme</div>
      <div class="scheme-options" id="schemeOptions">
        <button class="scheme-btn active" data-scheme="green" style="--c:#c8f0a0">
          <span class="scheme-dot" style="background:#c8f0a0;box-shadow:0 0 8px rgba(200,240,160,0.6)"></span>green
        </button>
        <button class="scheme-btn" data-scheme="blue" style="--c:#93c5fd">
          <span class="scheme-dot" style="background:#93c5fd;box-shadow:0 0 8px rgba(147,197,253,0.6)"></span>blue
        </button>
        <button class="scheme-btn" data-scheme="purple" style="--c:#c4b5fd">
          <span class="scheme-dot" style="background:#c4b5fd;box-shadow:0 0 8px rgba(196,181,253,0.6)"></span>purple
        </button>
        <button class="scheme-btn" data-scheme="amber" style="--c:#fcd34d">
          <span class="scheme-dot" style="background:#fcd34d;box-shadow:0 0 8px rgba(252,211,77,0.6)"></span>amber
        </button>
        <button class="scheme-btn" data-scheme="red" style="--c:#fca5a5">
          <span class="scheme-dot" style="background:#fca5a5;box-shadow:0 0 8px rgba(252,165,165,0.6)"></span>red
        </button>
        <button class="scheme-btn" data-scheme="cyan" style="--c:#67e8f9">
          <span class="scheme-dot" style="background:#67e8f9;box-shadow:0 0 8px rgba(103,232,249,0.6)"></span>cyan
        </button>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">about</div>
      <div style="font-size:11px;color:#555;line-height:1.8;letter-spacing:0.04em;">
        oblivion — between here and nowhere<br>
        <a href="https://discord.gg/gmb2RegMTd" target="_blank" style="color:#666;text-decoration:none;transition:color 0.15s;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='#666'">discord ↗</a>
      </div>
    </div>

  </div>
</div>

<!-- ══ TASKBAR ══ -->
<div id="taskbar">
  <button class="taskbar-btn active" data-screen="home" title="home">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9.5L10 3l7 6.5V17a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/>
      <path d="M7 18v-6h6v6"/>
    </svg>
  </button>
  <div class="taskbar-sep"></div>
  <button class="taskbar-btn" data-screen="browser" title="browser">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="10" cy="10" r="8"/>
      <path d="M2 10h16M10 2c-2 3-3 5-3 8s1 5 3 8M10 2c2 3 3 5 3 8s-1 5-3 8"/>
    </svg>
  </button>
  <button class="taskbar-btn" data-screen="games" title="games">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <rect x="2" y="6" width="16" height="11" rx="3"/>
      <path d="M6 11.5v-2m0 0v-2m0 2H4m2 0h2"/>
      <circle cx="14" cy="9.5" r="0.8" fill="currentColor" stroke="none"/>
      <circle cx="16" cy="11.5" r="0.8" fill="currentColor" stroke="none"/>
      <circle cx="12" cy="11.5" r="0.8" fill="currentColor" stroke="none"/>
      <circle cx="14" cy="13.5" r="0.8" fill="currentColor" stroke="none"/>
    </svg>
  </button>
  <button class="taskbar-btn" data-screen="music" title="music">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <path d="M7 15.5V5.5l10-2v10"/>
      <circle cx="5" cy="15.5" r="2"/><circle cx="15" cy="13.5" r="2"/>
    </svg>
  </button>
  <button class="taskbar-btn" data-screen="account" title="account">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="10" cy="7" r="3.5"/>
      <path d="M2 18c0-4 3.5-6 8-6s8 2 8 6"/>
    </svg>
  </button>
  <div class="taskbar-sep"></div>
  <button class="taskbar-btn" data-screen="settings" title="settings">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 5h14M3 10h14M3 15h14"/>
      <circle cx="7" cy="5" r="2" fill="var(--bg)" stroke="currentColor"/>
      <circle cx="13" cy="10" r="2" fill="var(--bg)" stroke="currentColor"/>
      <circle cx="7" cy="15" r="2" fill="var(--bg)" stroke="currentColor"/>
    </svg>
  </button>
</div>

<script src="/scram/scramjet.all.js"></script>
<script src="/register-sw.js"></script>
<script type="module">
import { BareMuxConnection } from '/baremux/index.mjs';

const { ScramjetController } = $scramjetLoadController();
const scramjet = new ScramjetController({
  files: { wasm: '/scram/scramjet.wasm.wasm', all: '/scram/scramjet.all.js', sync: '/scram/scramjet.sync.js' },
});
scramjet.init('/sw.js');
const connection = new BareMuxConnection('/baremux/worker.js');

// ── TOAST ──────────────────────────────────────────────────────────────
function toast(msg, type = 'info', duration = 3000) {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span class="toast-dot"></span>${msg}`;
  document.getElementById('toastContainer').appendChild(el);
  requestAnimationFrame(() => requestAnimationFrame(() => el.classList.add('show')));
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 220); }, duration);
}
(async () => {
  try {
    toast('scramjet initializing...', 'info', 2000);
    await navigator.serviceWorker.register('/sw.js');
    setTimeout(() => toast('scramjet ready', 'success', 2500), 800);
  } catch(e) { toast('scramjet failed to initialize', 'error', 4000); }
})();

// ── BACKGROUND ─────────────────────────────────────────────────────────
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
let W, H, bgAnimId = null;
const mouse = { x: -9999, y: -9999 };
let currentBg = localStorage.getItem('oblivionBg') || 'rain';

function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
window.addEventListener('resize', () => { resize(); startBg(currentBg); });
window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mouseleave', () => { mouse.x = -9999; mouse.y = -9999; });
resize();

// particles
let particles=[], tick=0, trail=[], trailIndex=0;
const TRAIL_LENGTH=20;
function initParticles(){
  tick=0; trailIndex=0;
  trail = Array.from({length:TRAIL_LENGTH},()=>({x:-9999,y:-9999}));
  particles = Array.from({length:Math.floor((W*H)/7000)},()=>({
    x:Math.random()*W, y:Math.random()*H, vx:(Math.random()-0.5)*0.4, vy:(Math.random()-0.5)*0.4,
    r:Math.random()*1.8+0.4, alpha:Math.random()*0.35+0.08, connections:[]
  }));
}
function drawParticles(){
  tick++; ctx.clearRect(0,0,W,H);
  trail[trailIndex]={x:mouse.x,y:mouse.y}; trailIndex=(trailIndex+1)%TRAIL_LENGTH;
  for(let i=0;i<TRAIL_LENGTH;i++){
    const idx=(trailIndex-1-i+TRAIL_LENGTH)%TRAIL_LENGTH;
    const t=trail[idx]; if(t.x===-9999)continue;
    const a=(1-i/TRAIL_LENGTH)*0.18;
    ctx.beginPath(); ctx.arc(t.x,t.y,(1-i/TRAIL_LENGTH)*2.5,0,Math.PI*2);
    ctx.fillStyle=`rgba(200,240,160,${a})`; ctx.fill();
  }
  for(let p of particles){
    if(mouse.x!==-9999){const dx=mouse.x-p.x,dy=mouse.y-p.y,d=Math.sqrt(dx*dx+dy*dy);if(d<100&&d>0){p.vx-=(dx/d)*0.06;p.vy-=(dy/d)*0.06;}}
    p.vx*=0.99;p.vy*=0.99;p.x+=p.vx;p.y+=p.vy;
    if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;
  }
  for(let i=0;i<particles.length;i++){
    for(let j=i+1;j<particles.length;j++){
      const dx=particles[i].x-particles[j].x,dy=particles[i].y-particles[j].y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<100){ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);ctx.lineTo(particles[j].x,particles[j].y);ctx.strokeStyle=`rgba(200,240,160,${(1-d/100)*0.12})`;ctx.lineWidth=0.6;ctx.stroke();}
    }
    ctx.beginPath();ctx.arc(particles[i].x,particles[i].y,particles[i].r,0,Math.PI*2);
    ctx.fillStyle=`rgba(200,240,160,${particles[i].alpha})`;ctx.fill();
  }
  bgAnimId=requestAnimationFrame(drawParticles);
}

// rain
let rainDrops=[],splashes=[];
function initRain(){
  splashes=[];
  const cols=Math.floor(W/9);
  rainDrops=Array.from({length:cols},()=>({
    x:Math.random()*W, y:Math.random()*-H,
    speed:Math.random()*3+2.5,
    len:Math.random()*18+8,
    op:Math.random()*0.28+0.06,
    w:Math.random()*0.6+0.2,
    wind:(Math.random()-0.3)*0.6  // mostly slight right lean, some variation
  }));
}
function drawRain(){
  ctx.clearRect(0,0,W,H);
  for(let d of rainDrops){
    const dropH = d.len * 10;
    const dropX = d.wind * dropH;
    const g=ctx.createLinearGradient(d.x - dropX, d.y - dropH, d.x, d.y);
    g.addColorStop(0,'rgba(180,200,255,0)');
    g.addColorStop(0.6,`rgba(200,215,255,${d.op * 0.5})`);
    g.addColorStop(1,`rgba(215,225,255,${d.op})`);
    ctx.beginPath(); ctx.moveTo(d.x - dropX, d.y - dropH); ctx.lineTo(d.x, d.y);
    ctx.strokeStyle=g; ctx.lineWidth=d.w; ctx.stroke();
    d.x += d.wind * 0.8; d.y += d.speed * 4;
    if(d.y > H + 20){
      if(Math.random()<0.12) splashes.push({x:d.x,y:H-2,vx:(Math.random()-0.5)*1.5,vy:-Math.random()*1.5-0.5,life:1,decay:0.08});
      d.y = Math.random() * -H * 0.5;
      d.x = Math.random() * W;
      d.speed = Math.random()*3+2.5;
      d.op = Math.random()*0.28+0.06;
    }
  }
  for(let i=splashes.length-1;i>=0;i--){
    const s=splashes[i];
    ctx.beginPath();ctx.arc(s.x,s.y,1.2*s.life,0,Math.PI*2);
    ctx.fillStyle=`rgba(200,215,255,${s.life*0.3})`;ctx.fill();
    s.x+=s.vx;s.y+=s.vy;s.vy+=0.1;s.life-=s.decay;
    if(s.life<=0)splashes.splice(i,1);
  }
  bgAnimId=requestAnimationFrame(drawRain);
}
window.addEventListener('click',e=>{if(currentBg==='rain'){for(let i=0;i<12;i++)splashes.push({x:e.clientX,y:e.clientY,vx:(Math.random()-0.5)*4,vy:-Math.random()*3-1,life:1,decay:0.04});}});

// matrix
let matrixCols=[],matrixTick=0;
const MATRIX_CHARS='ｦｧｨｩｪｫｬｭｮｯｰｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝ0123456789';const MATRIX_FS=13;
function initMatrix(){matrixTick=0;const cols=Math.floor(W/MATRIX_FS);matrixCols=Array.from({length:cols},()=>{const len=Math.floor(Math.random()*28+10);return{x:0,y:-(Math.random()*H),speed:Math.random()*0.4+0.15,chars:Array.from({length:len},()=>MATRIX_CHARS[Math.floor(Math.random()*MATRIX_CHARS.length)]),charTimer:0,charInterval:Math.floor(Math.random()*8+4),alpha:Math.random()*0.25+0.05};});}
function drawMatrix(){
  matrixTick++;ctx.fillStyle='rgba(5,5,7,0.18)';ctx.fillRect(0,0,W,H);
  for(let i=0;i<matrixCols.length;i++){
    const col=matrixCols[i];col.x=i*MATRIX_FS;
    let dist=99999;if(mouse.x!==-9999){const dx=col.x-mouse.x;dist=Math.abs(dx);}
    const proximity=Math.max(0,1-dist/180);const speed=col.speed*(1+proximity*3);const baseAlpha=col.alpha*(1+proximity*2);
    col.charTimer++;if(col.charTimer>=col.charInterval){col.charTimer=0;if(Math.random()<0.3)col.chars[Math.floor(Math.random()*col.chars.length)]=MATRIX_CHARS[Math.floor(Math.random()*MATRIX_CHARS.length)];}
    for(let j=0;j<col.chars.length;j++){
      const cy=col.y+j*MATRIX_FS;if(cy<0||cy>H)continue;
      const isHead=j===col.chars.length-1;
      if(isHead){ctx.fillStyle=`rgba(220,255,220,${baseAlpha*3})`;ctx.font=`bold ${MATRIX_FS}px monospace`;}
      else{const fade=1-j/col.chars.length;ctx.fillStyle=`rgba(100,${Math.floor(160+proximity*80)},80,${fade*baseAlpha})`;ctx.font=`${MATRIX_FS}px monospace`;}
      ctx.fillText(col.chars[j],col.x,cy);
    }
    col.y+=speed*MATRIX_FS*0.3;if(col.y>H)col.y=-col.chars.length*MATRIX_FS;
  }
  bgAnimId=requestAnimationFrame(drawMatrix);
}

// starfield
let stars=[],shootingStars=[],warpParticles=[],starTick=0;
function initStarfield(){starTick=0;shootingStars=[];warpParticles=[];stars=Array.from({length:320},()=>({x:Math.random()*W,y:Math.random()*H,z:Math.random(),size:Math.random()*1.6+0.2,bright:Math.random(),twinkle:Math.random()*Math.PI*2,twinkleSpeed:Math.random()*0.025+0.005,color:Math.random()>0.85?[255,220,180]:Math.random()>0.7?[180,200,255]:[215,215,235]}));}
function drawStarfield(){
  starTick++;ctx.clearRect(0,0,W,H);
  if(mouse.x!==-9999){const r=W*0.42;const g=ctx.createRadialGradient(mouse.x,mouse.y,0,mouse.x,mouse.y,r);g.addColorStop(0,'rgba(18,12,35,0.09)');g.addColorStop(0.4,'rgba(14,10,28,0.05)');g.addColorStop(0.75,'rgba(8,6,16,0.02)');g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.fillRect(0,0,W,H);}
  const ox=mouse.x===-9999?0:(mouse.x-W/2)*0.018,oy=mouse.y===-9999?0:(mouse.y-H/2)*0.018;
  if(starTick%280===0&&Math.random()<0.6)shootingStars.push({x:Math.random()*W*0.7,y:Math.random()*H*0.4,vx:Math.random()*6+4,vy:Math.random()*3+1.5,life:1,decay:0.018,len:Math.floor(Math.random()*60+30)});
  for(let s of stars){s.twinkle+=s.twinkleSpeed;const tw=0.55+Math.sin(s.twinkle)*0.45;const px=s.x+ox*s.z,py=s.y+oy*s.z;const alpha=(0.25+s.bright*0.55)*tw;const r=s.size*(0.4+s.bright*0.7);if(s.bright>0.75){ctx.shadowBlur=4+s.bright*6;ctx.shadowColor=`rgba(${s.color[0]},${s.color[1]},${s.color[2]},${alpha*0.6})`;}ctx.beginPath();ctx.arc(px,py,r,0,Math.PI*2);ctx.fillStyle=`rgba(${s.color[0]},${s.color[1]},${s.color[2]},${alpha})`;ctx.fill();ctx.shadowBlur=0;}
  for(let i=shootingStars.length-1;i>=0;i--){const ss=shootingStars[i];const g=ctx.createLinearGradient(ss.x-ss.vx*ss.len/6,ss.y-ss.vy*ss.len/6,ss.x,ss.y);g.addColorStop(0,'rgba(210,220,255,0)');g.addColorStop(1,`rgba(230,235,255,${ss.life*0.8})`);ctx.beginPath();ctx.moveTo(ss.x-ss.vx*ss.len/6,ss.y-ss.vy*ss.len/6);ctx.lineTo(ss.x,ss.y);ctx.strokeStyle=g;ctx.lineWidth=ss.life*1.5;ctx.stroke();ss.x+=ss.vx;ss.y+=ss.vy;ss.life-=ss.decay;if(ss.life<=0)shootingStars.splice(i,1);}
  for(let i=warpParticles.length-1;i>=0;i--){const p=warpParticles[i];ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);ctx.fillStyle=`rgba(${p.color[0]},${p.color[1]},${p.color[2]},${p.life*0.7})`;ctx.fill();p.x+=p.vx;p.y+=p.vy;p.life-=p.decay;if(p.life<=0)warpParticles.splice(i,1);}
  bgAnimId=requestAnimationFrame(drawStarfield);
}
window.addEventListener('click',e=>{if(currentBg==='starfield'){for(let i=0;i<60;i++){const angle=Math.random()*Math.PI*2,speed=Math.random()*5+1;warpParticles.push({x:e.clientX,y:e.clientY,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:1,decay:Math.random()*0.025+0.01,r:Math.random()*1.5+0.3,color:Math.random()>0.5?[200,210,255]:[255,240,200]});}}});

// dot grid
let dotGrid=[],dotTick=0;const DOT_SPACING=28;
function initDotGrid(){dotTick=0;dotGrid=[];const cols=Math.ceil(W/DOT_SPACING)+1,rows=Math.ceil(H/DOT_SPACING)+1;for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)dotGrid.push({bx:c*DOT_SPACING,by:r*DOT_SPACING,x:c*DOT_SPACING,y:r*DOT_SPACING,baseR:Math.random()*0.8+0.6,phase:Math.random()*Math.PI*2,phaseSpeed:Math.random()*0.004+0.001,baseAlpha:Math.random()*0.12+0.06});}
function drawDotGrid(){
  dotTick++;ctx.clearRect(0,0,W,H);const waveTime=dotTick*0.012;
  for(let d of dotGrid){
    d.phase+=d.phaseSpeed;const breathe=Math.sin(d.phase)*0.3;
    const waveOffset=Math.sin(d.bx*0.022+waveTime)*6+Math.sin(d.bx*0.011-waveTime*0.7)*3;
    let tx=d.bx,ty=d.by+waveOffset,extraR=0,extraAlpha=0,greenTint=0;
    if(mouse.x!==-9999){const dx=d.bx-mouse.x,dy=d.by-mouse.y,dist=Math.sqrt(dx*dx+dy*dy);if(dist<140&&dist>0){const force=Math.pow(1-dist/140,2);tx=d.bx+(dx/dist)*force*18;ty=d.by+waveOffset+(dy/dist)*force*18;extraR=force*2.8;extraAlpha=force*0.5;greenTint=force;}}
    d.x+=(tx-d.x)*0.1;d.y+=(ty-d.y)*0.1;
    const r=d.baseR+extraR+breathe,alpha=d.baseAlpha+extraAlpha;
    if(greenTint>0.1){const g=Math.floor(170+greenTint*70),gb=Math.floor(80+greenTint*80);ctx.fillStyle=`rgba(${Math.floor(180+greenTint*40)},${g},${gb},${alpha})`;}
    else ctx.fillStyle=`rgba(180,185,195,${alpha})`;
    ctx.beginPath();ctx.arc(d.x,d.y,Math.max(0.1,r),0,Math.PI*2);ctx.fill();
  }
  bgAnimId=requestAnimationFrame(drawDotGrid);
}

function startBg(name){
  if(bgAnimId)cancelAnimationFrame(bgAnimId);bgAnimId=null;ctx.clearRect(0,0,W,H);
  currentBg=name;localStorage.setItem('oblivionBg',name);
  if(name==='particles'){initParticles();drawParticles();}
  else if(name==='rain'){initRain();drawRain();}
  else if(name==='matrix'){initMatrix();drawMatrix();}
  else if(name==='starfield'){initStarfield();drawStarfield();}
  else if(name==='dots'){initDotGrid();drawDotGrid();}
  document.querySelectorAll('.bg-option').forEach(o=>o.classList.toggle('active',o.dataset.bg===name));
}
startBg(currentBg);

// preview thumbnails
function drawPreview(type,c){
  const pc=document.getElementById(`prev-canvas-${type}`);if(!pc)return;
  const pctx=pc.getContext('2d');const pw=pc.offsetWidth,ph=pc.offsetHeight;
  pc.width=pw;pc.height=ph;pctx.clearRect(0,0,pw,ph);
  if(type==='particles'){for(let i=0;i<18;i++){const x=Math.random()*pw,y=Math.random()*ph;pctx.beginPath();pctx.arc(x,y,Math.random()*1.5+0.3,0,Math.PI*2);pctx.fillStyle=`rgba(200,240,160,${Math.random()*0.5+0.1})`;pctx.fill();}
  }else if(type==='rain'){for(let i=0;i<24;i++){const x=Math.random()*pw,y=Math.random()*ph,l=Math.random()*12+6;const g=pctx.createLinearGradient(x-2,y-l,x,y);g.addColorStop(0,'rgba(200,215,255,0)');g.addColorStop(1,`rgba(210,220,255,${Math.random()*0.4+0.1})`);pctx.beginPath();pctx.moveTo(x-2,y-l);pctx.lineTo(x,y);pctx.strokeStyle=g;pctx.lineWidth=0.5;pctx.stroke();}
  }else if(type==='matrix'){for(let i=0;i<8;i++){for(let j=0;j<5;j++){pctx.fillStyle=`rgba(100,200,80,${Math.random()*0.3+0.05})`;pctx.font='6px monospace';pctx.fillText(MATRIX_CHARS[Math.floor(Math.random()*MATRIX_CHARS.length)],i*8+2,j*10+8);}}
  }else if(type==='starfield'){for(let i=0;i<30;i++){pctx.beginPath();pctx.arc(Math.random()*pw,Math.random()*ph,Math.random()*1.2+0.2,0,Math.PI*2);pctx.fillStyle=`rgba(215,215,235,${Math.random()*0.6+0.1})`;pctx.fill();}
  }else if(type==='dots'){const sp=8;for(let x=sp;x<pw;x+=sp)for(let y=sp;y<ph;y+=sp){pctx.beginPath();pctx.arc(x,y,0.8,0,Math.PI*2);pctx.fillStyle=`rgba(180,185,195,${Math.random()*0.15+0.05})`;pctx.fill();}}
}
setTimeout(()=>['particles','rain','matrix','starfield','dots'].forEach(t=>drawPreview(t)),300);
document.querySelectorAll('.bg-option').forEach(o=>o.addEventListener('click',()=>startBg(o.dataset.bg)));

// ── SCREEN NAVIGATION ──────────────────────────────────────────────────
let currentScreen = 'home';
function navigate(screenId) {
  if (screenId === currentScreen) return;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(`screen-${screenId}`);
  if (target) { target.classList.add('active'); currentScreen = screenId; }
  document.querySelectorAll('.taskbar-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.screen === screenId || (screenId !== 'home' && b.dataset.screen === screenId));
  });
  // update home button separately
  document.querySelector('.taskbar-btn[data-screen="home"]').classList.toggle('active', screenId === 'home');
}

document.querySelectorAll('.app-icon').forEach(icon => {
  icon.addEventListener('click', () => navigate(icon.dataset.screen));
});
document.querySelectorAll('.taskbar-btn').forEach(btn => {
  btn.addEventListener('click', () => navigate(btn.dataset.screen));
});

// ── BROWSER ────────────────────────────────────────────────────────────
let tabs = [], activeTabId = null, tabCounter = 0;

function createTab(url = null) {
  const id = ++tabCounter;
  const frame = document.createElement('div');
  frame.className = 'browser-frame-slot';
  frame.id = `frame-${id}`;
  document.getElementById('browserFrames').appendChild(frame);

  if (url) {
    const iframe = document.createElement('iframe');
    iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-popups';
    iframe.allowFullscreen = true;
    frame.appendChild(iframe);
  } else {
    frame.innerHTML = `<div class="newtab-page"><div class="newtab-wordmark" id="newtab-wm-${id}">oblivion</div><div class="newtab-hint" id="newtab-hint-${id}"><span class="newtab-arrow">↑</span> type in the search bar above</div></div>`;
  }

  const tab = { id, url, title: url ? (()=>{ try{ return new URL(url.startsWith('http')?url:'https://'+url).hostname; }catch(e){ return url.slice(0,20); } })() : 'new tab', frame };
  tabs.push(tab);
  renderTabs(id); // pass id so renderTabs applies entering animation
  setActiveTab(id);
  return tab;
}

function renderTabs(enteringId = null) {
  const container = document.getElementById('browserTabs');
  const newBtn = document.getElementById('newTabBtn');
  container.querySelectorAll('.browser-tab').forEach(el => el.remove());
  tabs.forEach(tab => {
    const el = document.createElement('div');
    el.className = 'browser-tab' + (tab.id === activeTabId ? ' active' : '');
    el.dataset.tabId = tab.id;
    el.innerHTML = `<span class="browser-tab-title">${tab.title}</span><button class="browser-tab-close" data-id="${tab.id}">×</button>`;
    el.addEventListener('click', e => { if (!e.target.classList.contains('browser-tab-close')) setActiveTab(tab.id); });
    el.querySelector('.browser-tab-close').addEventListener('click', e => { e.stopPropagation(); closeTab(tab.id); });
    container.insertBefore(el, newBtn);
    if (tab.id === enteringId) {
      el.classList.add('tab-entering');
      el.addEventListener('animationend', () => el.classList.remove('tab-entering'), { once: true });
    }
  });
}

function setActiveTab(id) {
  activeTabId = id;
  tabs.forEach(t => { t.frame.classList.toggle('active', t.id === id); });
  const tab = tabs.find(t => t.id === id);
  if (tab) document.getElementById('browserAddr').value = tab.url || '';
  // Just update active class — don't rebuild DOM
  document.querySelectorAll('.browser-tab').forEach(el => {
    el.classList.toggle('active', parseInt(el.dataset.tabId) === id);
  });
}

function closeTab(id) {
  const idx = tabs.findIndex(t => t.id === id);
  const tab = tabs[idx];
  const el = document.querySelector(`.browser-tab[data-tab-id="${id}"]`);
  const doClose = () => {
    tab.frame.remove();
    tabs.splice(idx, 1);
    if (tabs.length === 0) createTab();
    else if (activeTabId === id) setActiveTab(tabs[Math.min(idx, tabs.length-1)].id);
    else renderTabs();
  };
  if (el) {
    el.classList.add('tab-leaving');
    el.addEventListener('animationend', doClose, { once: true });
  } else {
    doClose();
  }
}

async function browserNavigate(url) {
  let val = url || document.getElementById('browserAddr').value.trim();
  if (!val) return;
  if (!val.startsWith('http://') && !val.startsWith('https://')) {
    val = val.includes('.') && !val.includes(' ')
      ? 'https://' + val
      : document.getElementById('engineSelect').value + encodeURIComponent(val);
  }
  const tab = tabs.find(t => t.id === activeTabId);
  if (!tab) return;

  try {
    await navigator.serviceWorker.register('/sw.js');
    const wispUrl = (location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/wisp/';
    if ((await connection.getTransport()) !== '/libcurl/index.mjs') {
      toast('connecting...', 'info', 1500);
      await connection.setTransport('/libcurl/index.mjs', [{ websocket: wispUrl }]);
    }
    tab.frame.innerHTML = '';
    const sjFrame = scramjet.createFrame();
    sjFrame.frame.style.cssText = 'width:100%;height:100%;border:none;';
    tab.frame.appendChild(sjFrame.frame);
    sjFrame.go(val);
    tab.url = val;
    try { tab.title = new URL(val).hostname; } catch(e) { tab.title = val.slice(0,20); }
    document.getElementById('browserAddr').value = val;
    renderTabs();
    toast('navigating...', 'info', 1200);
  } catch(e) {
    toast('navigation failed', 'error', 3000);
  }
}

document.getElementById('browserGo').addEventListener('click', () => browserNavigate());
document.getElementById('browserAddr').addEventListener('keydown', e => { if(e.key==='Enter') browserNavigate(); });

// Hide/show newtab wordmark when typing in address bar
document.getElementById('browserAddr').addEventListener('input', e => {
  const tab = tabs.find(t => t.id === activeTabId);
  if (!tab || tab.url) return; // only on new tab pages
  const typing = e.target.value.length > 0;
  const wm = document.getElementById(`newtab-wm-${activeTabId}`);
  const hint = document.getElementById(`newtab-hint-${activeTabId}`);
  if (wm) wm.classList.toggle('hidden', typing);
  if (hint) hint.classList.toggle('hidden', typing);
});
document.getElementById('browserAddr').addEventListener('focus', e => {
  const tab = tabs.find(t => t.id === activeTabId);
  if (!tab || tab.url) return;
  if (e.target.value.length > 0) {
    const wm = document.getElementById(`newtab-wm-${activeTabId}`);
    const hint = document.getElementById(`newtab-hint-${activeTabId}`);
    if (wm) wm.classList.add('hidden');
    if (hint) hint.classList.add('hidden');
  }
});
document.getElementById('browserAddr').addEventListener('blur', e => {
  const tab = tabs.find(t => t.id === activeTabId);
  if (!tab || tab.url) return;
  if (e.target.value.length === 0) {
    const wm = document.getElementById(`newtab-wm-${activeTabId}`);
    const hint = document.getElementById(`newtab-hint-${activeTabId}`);
    if (wm) wm.classList.remove('hidden');
    if (hint) hint.classList.remove('hidden');
  }
});
document.getElementById('newTabBtn').addEventListener('click', () => { navigate('browser'); createTab(); });
document.getElementById('navBack').addEventListener('click', () => { const f = tabs.find(t=>t.id===activeTabId)?.frame.querySelector('iframe'); if(f) try{f.contentWindow.history.back();}catch(e){} });
document.getElementById('navForward').addEventListener('click', () => { const f = tabs.find(t=>t.id===activeTabId)?.frame.querySelector('iframe'); if(f) try{f.contentWindow.history.forward();}catch(e){} });
document.getElementById('navRefresh').addEventListener('click', () => { const tab = tabs.find(t=>t.id===activeTabId); if(tab?.url) browserNavigate(tab.url); });

// Create initial tab
createTab();

// ── GAMES ──────────────────────────────────────────────────────────────
const COVER_URL = 'https://cdn.jsdelivr.net/gh/gn-math/covers@main';
const HTML_URL = 'https://cdn.jsdelivr.net/gh/gn-math/html@main';
let allZones = [], popularityData = {};

function sortZones(zones, by) {
  if (by==='name') return [...zones].sort((a,b)=>a.name.localeCompare(b.name));
  if (by==='popular') return [...zones].sort((a,b)=>(popularityData[b.id]||0)-(popularityData[a.id]||0));
  if (by==='newest') return [...zones].sort((a,b)=>b.id-a.id);
  return zones;
}

async function loadGames() {
  try {
    const res = await fetch('https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json?t='+Date.now());
    const raw = await res.json();
    allZones = raw.filter(z => !z.name.startsWith('[!]'));
    try {
      const popRes = await fetch('https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year');
      const popData = await popRes.json();
      const files = Array.isArray(popData) ? popData : (popData.files || []);
      files.forEach(f => { const m = f.name?.match(/\/(\d+)\.html$/); if(m) popularityData[parseInt(m[1])] = f.hits?.total || f.hits || 0; });
    } catch(e) {}
    renderGames(allZones);
  } catch(e) {
    document.getElementById('gamesGrid').innerHTML = '<div class="games-loading">failed to load games</div>';
  }
}

function renderGames(zones) {
  const grid = document.getElementById('gamesGrid');
  const sortBy = document.getElementById('gamesSort').value;
  const sorted = sortZones(zones, sortBy);
  grid.classList.add('fading');
  setTimeout(() => {
    grid.innerHTML = '';
    if (!sorted.length) { grid.innerHTML = '<div class="games-loading">no games found</div>'; grid.classList.remove('fading'); return; }
    sorted.forEach(zone => {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.addEventListener('click', () => openGame(zone));
      const img = document.createElement('img');
      img.loading = 'lazy'; img.alt = zone.name;
      img.src = zone.cover.replace('{COVER_URL}', COVER_URL).replace('{HTML_URL}', HTML_URL);
      const name = document.createElement('div');
      name.className = 'game-card-name'; name.textContent = zone.name;
      card.appendChild(img); card.appendChild(name);
      grid.appendChild(card);
    });
    grid.classList.remove('fading');
  }, 180);
}

async function openGame(zone) {
  document.getElementById('gameViewerTitle').textContent = zone.name;
  document.getElementById('gameViewerAuthor').textContent = zone.author ? 'by '+zone.author : '';
  const viewer = document.getElementById('gameViewer');
  const frame = document.getElementById('gameFrame');
  viewer.classList.add('open');
  if (zone.url.startsWith('http')) {
    frame.src = zone.url;
  } else {
    frame.src = zone.url.replace('{HTML_URL}', HTML_URL).replace('{COVER_URL}', COVER_URL);
  }
}

document.getElementById('gameClose').addEventListener('click', () => {
  document.getElementById('gameViewer').classList.remove('open');
  document.getElementById('gameFrame').src = '';
});
document.getElementById('gameFullscreen').addEventListener('click', () => {
  document.getElementById('gameFrame').requestFullscreen?.();
});
document.getElementById('gameNewTab').addEventListener('click', () => {
  window.open(document.getElementById('gameFrame').src, '_blank');
});

document.getElementById('gamesSearch').addEventListener('input', e => {
  const q = e.target.value.toLowerCase();
  renderGames(q ? allZones.filter(z => z.name.toLowerCase().includes(q)) : allZones);
});
document.getElementById('gamesSort').addEventListener('change', () => {
  const q = document.getElementById('gamesSearch').value.toLowerCase();
  renderGames(q ? allZones.filter(z => z.name.toLowerCase().includes(q)) : allZones);
});

loadGames();

// ── CURSOR ─────────────────────────────────────────────────────────────
const glowEl = document.getElementById('cursorGlow');
const dotEl = document.getElementById('cursorDot');
let glowPos = { x: -9999, y: -9999 };

function animCursor() {
  glowPos.x += (mouse.x - glowPos.x) * 0.55;
  glowPos.y += (mouse.y - glowPos.y) * 0.55;
  glowEl.style.left = glowPos.x + 'px'; glowEl.style.top = glowPos.y + 'px';
  dotEl.style.left = mouse.x + 'px'; dotEl.style.top = mouse.y + 'px';
  requestAnimationFrame(animCursor);
}
animCursor();
window.addEventListener('mousemove', () => { glowEl.style.opacity = '1'; dotEl.style.opacity = '1'; });
window.addEventListener('mouseleave', () => { glowEl.style.opacity = '0'; dotEl.style.opacity = '0'; });

// Trail
const TRAIL_COUNT = 20;
const trailDots = Array.from({ length: TRAIL_COUNT }, (_, i) => {
  const el = document.createElement('div');
  el.className = 'cursor-trail';
  const size = Math.max(2, 7 - i * 0.28);
  el.style.cssText = `width:${size}px;height:${size}px;opacity:0;`;
  document.body.appendChild(el);
  return { el, x: -9999, y: -9999 };
});
let trailVisible = false;
function animTrail() {
  trailDots[0].x += (mouse.x - trailDots[0].x) * 0.6;
  trailDots[0].y += (mouse.y - trailDots[0].y) * 0.6;
  for (let i = 1; i < TRAIL_COUNT; i++) {
    trailDots[i].x += (trailDots[i-1].x - trailDots[i].x) * 0.35;
    trailDots[i].y += (trailDots[i-1].y - trailDots[i].y) * 0.35;
  }
  trailDots.forEach((d, i) => {
    d.el.style.left = d.x + 'px'; d.el.style.top = d.y + 'px';
    d.el.style.opacity = trailVisible ? (1 - i / TRAIL_COUNT) * 0.9 : 0;
  });
  requestAnimationFrame(animTrail);
}
animTrail();
window.addEventListener('mousemove', () => { trailVisible = true; });
window.addEventListener('mouseleave', () => { trailVisible = false; });

// ── PANIC KEY ──────────────────────────────────────────────────────────
let panicKey = localStorage.getItem('oblivionPanicKey') || '';
let panicUrl = localStorage.getItem('oblivionPanicUrl') || 'https://clever.com';
let settingPanic = false;
const panicKeyDisplay = document.getElementById('panicKeyDisplay');
const panicSetBtn = document.getElementById('panicSetBtn');
const panicUrlInput = document.getElementById('panicUrl');
panicKeyDisplay.textContent = panicKey || '?';
panicUrlInput.value = panicUrl;
panicSetBtn.addEventListener('click', () => { settingPanic = true; panicSetBtn.textContent = 'listening...'; });
panicUrlInput.addEventListener('change', () => { panicUrl = panicUrlInput.value.trim(); localStorage.setItem('oblivionPanicUrl', panicUrl); });
window.addEventListener('keydown', e => {
  if (settingPanic) { panicKey = e.key; localStorage.setItem('oblivionPanicKey', panicKey); panicKeyDisplay.textContent = panicKey; panicSetBtn.textContent = 'press to set key'; settingPanic = false; return; }
  if (panicKey && e.key === panicKey) {
    const flash = document.getElementById('panicFlash'); flash.style.opacity = '1';
    setTimeout(() => { const url = panicUrl.startsWith('http') ? panicUrl : 'https://'+panicUrl; window.location.replace(url); }, 80);
  }
});

// ── CLOAK ──────────────────────────────────────────────────────────────
let currentCloakIcon = '/void-icon.svg';
function setFavicon(url) {
  let link = document.querySelector("link[rel~='icon']");
  if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
  link.href = url;
}
const savedTitle = localStorage.getItem('oblivionCloakTitle');
const savedIcon = localStorage.getItem('oblivionCloakIcon');
if (savedTitle) document.title = savedTitle;
if (savedIcon) { setFavicon(savedIcon); currentCloakIcon = savedIcon; }

document.querySelectorAll('.cloak-preset').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.cloak-preset').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); currentCloakIcon = btn.dataset.icon;
    document.getElementById('cloakTitle').value = btn.dataset.title;
    document.getElementById('cloakIcon').value = '';
  });
});
document.getElementById('cloakIcon').addEventListener('input', e => { if(e.target.value.trim()){ document.querySelectorAll('.cloak-preset').forEach(b=>b.classList.remove('active')); currentCloakIcon=e.target.value.trim(); }});
document.getElementById('applyCloak').addEventListener('click', () => {
  const title = document.getElementById('cloakTitle').value.trim();
  const icon = document.getElementById('cloakIcon').value.trim() || currentCloakIcon;
  if (title) { document.title = title; localStorage.setItem('oblivionCloakTitle', title); }
  if (icon) { setFavicon(icon); localStorage.setItem('oblivionCloakIcon', icon); }
  const btn = document.getElementById('applyCloak'); btn.textContent = 'applied ✓';
  setTimeout(() => btn.textContent = 'apply cloak', 1500);
});
// ── COLOR SCHEME ───────────────────────────────────────────────────────
const savedScheme = localStorage.getItem('oblivionScheme') || 'green';
function applyScheme(name) {
  document.body.className = document.body.className.replace(/scheme-\w+/g, '').trim();
  if (name !== 'green') document.body.classList.add('scheme-' + name);
  localStorage.setItem('oblivionScheme', name);
  document.querySelectorAll('.scheme-btn').forEach(b => b.classList.toggle('active', b.dataset.scheme === name));
}
applyScheme(savedScheme);
document.querySelectorAll('.scheme-btn').forEach(btn => {
  btn.addEventListener('click', () => applyScheme(btn.dataset.scheme));
});

document.getElementById('resetCloak').addEventListener('click', () => {
  document.title = 'oblivion'; setFavicon('/void-icon.svg');
  localStorage.removeItem('oblivionCloakTitle'); localStorage.removeItem('oblivionCloakIcon');
  document.getElementById('cloakTitle').value = ''; document.getElementById('cloakIcon').value = '';
  document.querySelectorAll('.cloak-preset').forEach(b => b.classList.remove('active'));
  document.querySelector('.cloak-preset[data-title="oblivion"]').classList.add('active');
  currentCloakIcon = '/void-icon.svg';
});

</script>
</body>
</html>
