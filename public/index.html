<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>oblivion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<link rel="icon" type="image/svg+xml" href="/void-icon.svg">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #020204;
  --surface: #07070a;
  --surface2: #0d0d11;
  --border: rgba(255,255,255,0.10);
  --border-hi: rgba(255,255,255,0.16);
  --text: #e8e8e8;
  --muted: #666;
  --dim: #444;
  --accent: #c8f0a0;
  --accent-rgb: 200,240,160;
  --font-display: 'DM Serif Display', serif;
  --font-mono: 'DM Mono', monospace;
}

/* ── COLOR SCHEMES ── */
/* scheme classes injected by JS */

html, body { height: 100%; overflow: hidden; cursor: none; background: var(--bg); color: var(--text); font-family: var(--font-mono); font-weight: 300; font-size: 13px; }

canvas#bg { position: fixed; inset: 0; z-index: 0; }

#grain-overlay {
  position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.06;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='1'/%3E%3C/svg%3E");
  background-repeat: repeat; background-size: 180px 180px;
}

.vignette {
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.35) 100%);
}

/* ── CURSOR ── */
.cursor-glow {
  position: fixed; width: 280px; height: 280px; border-radius: 50%;
  pointer-events: none; z-index: 99998; transform: translate(-50%,-50%);
  background: radial-gradient(circle, rgba(220,230,255,0.028) 0%, transparent 70%);
  transition: opacity 0.3s; opacity: 0;
}
.cursor-dot {
  position: fixed; width: 6px; height: 6px; border-radius: 50%;
  background: rgba(255,255,255,0.9); pointer-events: none; z-index: 99999;
  transform: translate(-50%,-50%); box-shadow: 0 0 6px rgba(255,255,255,0.4);
  transition: opacity 0.3s; opacity: 0;
}
.cursor-trail {
  position: fixed; border-radius: 50%; pointer-events: none; z-index: 99997;
  transform: translate(-50%,-50%); background: rgba(235,245,220,0.9);
}

/* ── PANIC FLASH ── */
.panic-flash { position: fixed; inset: 0; z-index: 99999; background: #fff; opacity: 0; pointer-events: none; transition: opacity 0.05s; }

/* ── SCREENS ── */
.screen {
  position: fixed; inset: 0; z-index: 1;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s ease;
}
.screen.active { opacity: 1; pointer-events: all; }

/* ── HOME SCREEN ── */
#screen-home {
  justify-content: center;
  padding-bottom: 80px;
}
#screen-home::before {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -58%);
  width: 500px; height: 500px;
  background: radial-gradient(ellipse at center,
    rgba(var(--accent-rgb), 0.04) 0%,
    rgba(var(--accent-rgb), 0.015) 35%,
    transparent 70%);
  pointer-events: none;
  animation: glowPulse 6s ease-in-out infinite;
}
@keyframes glowPulse {
  0%, 100% { opacity: 0.7; transform: translate(-50%, -58%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -58%) scale(1.08); }
}

.wordmark {
  font-family: var(--font-display);
  font-size: clamp(1.8rem, 4vw, 2.8rem);
  color: var(--text); letter-spacing: -0.02em;
  text-shadow:
    0 0 20px rgba(255,255,255,0.35),
    0 0 60px rgba(255,255,255,0.15),
    0 0 140px rgba(200,240,160,0.08);
  margin-bottom: 6px;
  opacity: 0; transform: translateY(10px);
  animation: fadeUp 0.7s ease forwards 0.2s;
}
.tagline {
  font-size: 10px; color: #3a3a42; letter-spacing: 0.18em;
  text-transform: uppercase; margin-bottom: 52px;
  opacity: 0; transform: translateY(8px);
  animation: fadeUp 0.7s ease forwards 0.4s;
  text-shadow: 0 0 20px rgba(200,240,160,0.12);
}
@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

/* App icon grid */
.app-grid {
  display: grid;
  grid-template-columns: repeat(5, 88px);
  gap: 12px;
  opacity: 0; transform: translateY(10px);
  animation: fadeUp 0.7s ease forwards 0.55s;
}

.app-icon {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 9px; cursor: none;
  transition: transform 0.18s ease;
}
.app-icon:hover { transform: translateY(-3px); }
.app-icon:hover .icon-tile {
  border-color: rgba(255,255,255,0.16);
  border-top-color: rgba(255,255,255,0.22);
  background: rgba(255,255,255,0.055);
  box-shadow:
    0 0 28px rgba(var(--accent-rgb),0.14),
    0 0 60px rgba(var(--accent-rgb),0.06),
    0 6px 24px rgba(0,0,0,0.5),
    inset 0 1px 0 rgba(255,255,255,0.1);
  transform: translateY(-1px);
}
.app-icon:hover .icon-tile svg {
  filter: drop-shadow(0 0 6px rgba(var(--accent-rgb),0.5));
}
.app-icon:hover .icon-label { color: #ccc; }

.icon-tile {
  width: 72px; height: 72px; border-radius: 18px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.09);
  border-top-color: rgba(255,255,255,0.15);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.25s ease;
  backdrop-filter: blur(12px);
  box-shadow:
    0 2px 16px rgba(0,0,0,0.5),
    inset 0 1px 0 rgba(255,255,255,0.07),
    0 0 0 0px rgba(var(--accent-rgb),0);
}
.icon-tile svg { width: 30px; height: 30px; }

.icon-label {
  font-size: 10px; color: #555; letter-spacing: 0.06em;
  text-transform: lowercase; transition: color 0.18s;
  text-align: center;
}

/* ── BROWSER APP ── */
#screen-browser {
  flex-direction: column; align-items: stretch;
  justify-content: flex-start; padding-bottom: 60px;
}

.browser-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  background: rgba(6,6,9,0.85);
  backdrop-filter: blur(24px);
  flex-shrink: 0;
  z-index: 10;
  box-shadow: 0 1px 0 rgba(255,255,255,0.04);
  overflow: hidden;
}

/* Chrome-style tabs — + button lives inside, stays glued after last tab */
.browser-tabs {
  display: flex; align-items: center; gap: 0;
  flex: 1; overflow: hidden; min-width: 0;
}

.browser-tab {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 10px 5px 12px;
  height: 30px;
  border-radius: 7px;
  background: transparent;
  border: 1px solid transparent;
  color: #555; font-family: var(--font-mono); font-size: 11px;
  cursor: none;
  flex: 1; min-width: 64px; max-width: 210px;
  transition: flex 0.2s cubic-bezier(0.4,0,0.2,1), max-width 0.2s cubic-bezier(0.4,0,0.2,1), min-width 0.2s cubic-bezier(0.4,0,0.2,1), background 0.15s, color 0.15s, border-color 0.15s, opacity 0.15s, transform 0.2s cubic-bezier(0.4,0,0.2,1);
  position: relative; overflow: hidden;
  transform-origin: left center;
  margin-right: 3px;
}
.browser-tab.tab-entering {
  animation: tabSlideIn 0.2s cubic-bezier(0.4,0,0.2,1) forwards;
}
.browser-tab.tab-leaving {
  animation: tabSlideOut 0.18s cubic-bezier(0.4,0,0.2,1) forwards;
}
@keyframes tabSlideIn {
  from { opacity: 0; transform: scaleX(0.4) translateX(-8px); max-width: 0; min-width: 0; flex: 0; }
  to   { opacity: 1; transform: scaleX(1) translateX(0); }
}
@keyframes tabSlideOut {
  from { opacity: 1; transform: scaleX(1); }
  to   { opacity: 0; transform: scaleX(0.4); max-width: 0; min-width: 0; flex: 0; margin-right: 0; }
}
.browser-tab.active {
  background: rgba(255,255,255,0.06);
  border-color: rgba(255,255,255,0.10);
  color: #ddd;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
}
.browser-tab:hover:not(.active) { color: #aaa; background: rgba(255,255,255,0.04); }
.browser-tab-title {
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  flex: 1; min-width: 0;
}
.browser-tab-close {
  background: none; border: none; color: #444; font-size: 13px;
  cursor: none; padding: 2px 3px; line-height: 1; transition: color 0.15s;
  flex-shrink: 0; border-radius: 4px; margin-left: 2px;
  opacity: 0; transition: opacity 0.15s, color 0.15s;
}
.browser-tab:hover .browser-tab-close,
.browser-tab.active .browser-tab-close { opacity: 1; }
.browser-tab-close:hover { color: #ccc; background: rgba(255,255,255,0.06); }

/* + sits right after last tab, no gap */
.browser-tab-new {
  background: none; border: none; color: #555; font-size: 17px; line-height: 1;
  cursor: none; padding: 5px 7px; transition: color 0.15s; flex-shrink: 0;
  font-family: var(--font-mono);
}
.browser-tab-new:hover { color: #ccc; }

/* Address bar row */
.browser-addr-row {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  background: rgba(5,5,7,0.6);
  backdrop-filter: blur(20px);
  flex-shrink: 0;
}

.browser-nav-btn {
  background: none; border: none; color: #777; font-size: 14px;
  cursor: none; padding: 4px 6px; transition: color 0.15s; flex-shrink: 0;
  font-family: var(--font-mono); line-height: 1;
}
.browser-nav-btn:hover { color: #bbb; }
.browser-nav-btn:disabled { opacity: 0.25; }

.browser-addr-wrap {
  flex: 1; display: flex; align-items: center;
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.13);
  border-radius: 7px; padding: 6px 12px; gap: 8px;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 0 12px rgba(255,255,255,0.025);
}
.browser-addr-wrap:focus-within {
  border-color: rgba(var(--accent-rgb),0.35);
  box-shadow: 0 0 0 2px rgba(var(--accent-rgb),0.09), 0 0 18px rgba(var(--accent-rgb),0.06), inset 0 1px 0 rgba(255,255,255,0.06);
}
.browser-addr { flex: 1; background: none; border: none; outline: none; color: #ccc; font-family: var(--font-mono); font-size: 12px; }
.browser-addr::placeholder { color: #555; }

.browser-go {
  background: none; border: none; color: #555;
  font-family: var(--font-mono); font-size: 11px; cursor: none;
  transition: color 0.15s; padding: 0 2px;
}
.browser-go:hover { color: var(--accent); }

/* Engine selector */
.engine-select {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.11);
  border-radius: 6px; color: #888;
  font-family: var(--font-mono); font-size: 10px;
  padding: 5px 8px; cursor: none; outline: none;
  transition: border-color 0.15s; flex-shrink: 0;
}
.engine-select:focus { border-color: rgba(255,255,255,0.12); }
.engine-select option { background: #0a0a0d; }

/* Browser frame area */
.browser-frames { flex: 1; position: relative; overflow: hidden; }
.browser-frame-slot {
  position: absolute; inset: 0; display: none;
}
.browser-frame-slot.active { display: block; }
.browser-frame-slot iframe {
  width: 100%; height: 100%; border: none;
}

/* New tab page */
.newtab-page {
  width: 100%; height: 100%;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 0; position: relative; user-select: none; padding-bottom: 40px;
}
.newtab-wordmark {
  font-family: var(--font-display);
  font-size: clamp(2rem, 5vw, 3.2rem);
  color: var(--text); letter-spacing: -0.02em;
  text-shadow: 0 0 60px rgba(255,255,255,0.14), 0 0 140px rgba(255,255,255,0.06);
  pointer-events: none; margin-bottom: 32px;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
.newtab-search-wrap {
  display: flex; align-items: center; gap: 10px;
  width: min(520px, 84vw);
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px; padding: 12px 16px; margin-bottom: 28px;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.06);
}
.newtab-search-wrap:focus-within {
  border-color: rgba(var(--accent-rgb),0.4);
  box-shadow: 0 0 0 3px rgba(var(--accent-rgb),0.08), 0 4px 24px rgba(0,0,0,0.3);
}
.newtab-search-wrap svg { flex-shrink: 0; color: #555; transition: color 0.2s; }
.newtab-search-wrap:focus-within svg { color: var(--accent); }
.newtab-search-input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-family: var(--font-mono); font-size: 13px;
}
.newtab-search-input::placeholder { color: #444; }
.newtab-search-go {
  background: none; border: none; color: #444; font-family: var(--font-mono);
  font-size: 11px; cursor: none; transition: color 0.15s; padding: 0 2px; letter-spacing: 0.05em;
}
.newtab-search-go:hover { color: var(--accent); }
.newtab-shortcuts { display: flex; gap: 20px; align-items: center; }
.newtab-shortcut {
  display: flex; flex-direction: column; align-items: center; gap: 7px;
  cursor: none; transition: transform 0.16s;
}
.newtab-shortcut:hover { transform: translateY(-2px); }
.newtab-shortcut-icon {
  width: 48px; height: 48px; border-radius: 14px;
  background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.09);
  border-top-color: rgba(255,255,255,0.14);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.18s; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.newtab-shortcut:hover .newtab-shortcut-icon {
  border-color: rgba(var(--accent-rgb),0.25);
  box-shadow: 0 4px 18px rgba(0,0,0,0.4), 0 0 14px rgba(var(--accent-rgb),0.08);
  background: rgba(255,255,255,0.06);
}
.newtab-shortcut-icon img { width: 24px; height: 24px; object-fit: contain; }
.newtab-shortcut-label { font-size: 10px; color: #555; letter-spacing: 0.05em; transition: color 0.16s; }
.newtab-shortcut:hover .newtab-shortcut-label { color: #aaa; }
.newtab-hint { font-size: 10px; color: #252530; letter-spacing: 0.1em; margin-top: 24px; text-transform: uppercase; pointer-events: none; }

/* ── GAMES APP ── */
#screen-games {
  flex-direction: column; align-items: stretch;
  justify-content: flex-start; padding-bottom: 60px;
}

.games-header {
  padding: 18px 20px 12px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  display: flex; align-items: center; gap: 10px;
  flex-shrink: 0;
  background: rgba(5,5,7,0.5); backdrop-filter: blur(20px);
}
.games-header-title { font-family: var(--font-display); font-size: 1.1rem; color: rgba(255,255,255,0.75); }
.games-search {
  flex: 1; max-width: 320px; margin-left: auto;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.11);
  border-radius: 7px; padding: 7px 12px;
  color: var(--text); font-family: var(--font-mono); font-size: 11px; outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: 0 0 10px rgba(255,255,255,0.02);
}
.games-search:focus { border-color: rgba(var(--accent-rgb),0.3); box-shadow: 0 0 14px rgba(var(--accent-rgb),0.06); }
.games-search::placeholder { color: #444; }
.games-sort-sel {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07);
  border-radius: 6px; color: #777; font-family: var(--font-mono); font-size: 10px;
  padding: 6px 8px; cursor: none; outline: none;
}
.games-sort-sel option { background: #0a0a0d; }

.games-scroll {
  flex: 1; overflow-y: auto; padding: 16px 20px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.05) transparent;
}
.games-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 10px;
  transition: opacity 0.18s;
}
.games-grid.fading { opacity: 0; }

.game-card {
  background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.09);
  border-top-color: rgba(255,255,255,0.13); border-radius: 10px; overflow: hidden;
  cursor: none; transition: border-color 0.18s, transform 0.18s, box-shadow 0.18s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.game-card:hover {
  border-color: rgba(var(--accent-rgb),0.25); transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 16px rgba(var(--accent-rgb),0.06);
}
.game-card img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; background: var(--surface2); }
.game-card-name { padding: 7px 8px 8px; font-size: 10px; color: #777; text-align: center; line-height: 1.3; }
.game-card:hover .game-card-name { color: #ccc; }

.games-loading { text-align: center; color: #444; font-size: 11px; padding: 60px; letter-spacing: 0.1em; text-transform: uppercase; }

/* Game viewer overlay */
.game-viewer {
  position: fixed; inset: 0; z-index: 200;
  display: flex; flex-direction: column;
  background: var(--bg);
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.game-viewer.open { opacity: 1; pointer-events: all; }
.game-viewer-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.04);
  background: rgba(5,5,7,0.8); backdrop-filter: blur(20px);
  flex-shrink: 0;
}
.game-viewer-title { font-size: 12px; color: #bbb; flex: 1; }
.game-viewer-author { font-size: 10px; color: #555; }
.gv-btn {
  background: none; border: 1px solid rgba(255,255,255,0.08); border-radius: 6px;
  color: #777; font-family: var(--font-mono); font-size: 10px;
  padding: 5px 10px; cursor: none; transition: all 0.15s; letter-spacing: 0.05em;
}
.gv-btn:hover { border-color: rgba(255,255,255,0.15); color: #ccc; }
.game-viewer iframe { flex: 1; border: none; width: 100%; }

/* ── SETTINGS APP ── */
#screen-settings {
  flex-direction: column; align-items: center;
  justify-content: flex-start; padding: 40px 20px 80px;
  overflow-y: auto; max-height: 100vh;
}
.settings-inner {
  width: min(520px, 92vw);
}
.settings-app-title {
  font-family: var(--font-display); font-size: 1.4rem;
  color: rgba(255,255,255,0.8); margin-bottom: 32px;
}
.settings-section {
  margin-bottom: 32px;
}
.settings-section-title {
  font-size: 9px; color: #555; letter-spacing: 0.14em;
  text-transform: uppercase; margin-bottom: 12px; padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

/* Background picker */
.bg-options {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;
}
.bg-option {
  border-radius: 8px; overflow: hidden; cursor: none;
  border: 1px solid rgba(255,255,255,0.09);
  transition: border-color 0.15s, box-shadow 0.15s; position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}
.bg-option:hover { border-color: rgba(255,255,255,0.16); }
.bg-option.active {
  border-color: rgba(var(--accent-rgb),0.45);
  box-shadow: 0 0 14px rgba(var(--accent-rgb),0.12);
}
.bg-option canvas { width: 100%; height: 52px; display: block; }
.bg-option-label { font-size: 9px; color: #666; text-align: center; padding: 4px 0 5px; letter-spacing: 0.05em; }
.bg-option.active .bg-option-label { color: var(--accent); }

/* Panic key */
.panic-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.panic-key-display {
  width: 36px; height: 36px; border-radius: 7px;
  background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; color: var(--text); flex-shrink: 0;
}
.panic-set-btn {
  background: none; border: 1px solid rgba(255,255,255,0.12); border-radius: 6px;
  color: #888; font-family: var(--font-mono); font-size: 10px;
  padding: 6px 12px; cursor: none; transition: all 0.15s;
}
.panic-set-btn:hover { border-color: rgba(255,255,255,0.15); color: #bbb; }
.panic-hint { font-size: 9px; color: #555; letter-spacing: 0.05em; line-height: 1.5; }

/* Cloak */
.cloak-label { font-size: 9px; color: #555; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 6px; }
.input-row {
  display: flex; align-items: center; gap: 8px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.12);
  border-radius: 7px; padding: 8px 12px; margin-bottom: 10px;
  transition: border-color 0.2s, box-shadow 0.2s;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 0 10px rgba(255,255,255,0.02);
}
.input-row:focus-within {
  border-color: rgba(var(--accent-rgb),0.35);
  box-shadow: 0 0 0 2px rgba(var(--accent-rgb),0.09), 0 0 16px rgba(var(--accent-rgb),0.06), inset 0 1px 0 rgba(255,255,255,0.06);
}
.input-row input {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-family: var(--font-mono); font-size: 12px;
}
.input-row input::placeholder { color: #444; }

.cloak-presets {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px;
}
.cloak-preset {
  display: flex; flex-direction: column; align-items: center; gap: 5px;
  padding: 9px 6px; background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.09); border-radius: 8px;
  color: #777; font-family: var(--font-mono); font-size: 10px;
  cursor: none; transition: all 0.15s; letter-spacing: 0.03em;
}
.cloak-preset img { width: 18px; height: 18px; object-fit: contain; border-radius: 3px; }
.cloak-preset:hover { color: #bbb; border-color: rgba(255,255,255,0.12); }
.cloak-preset.active { background: rgba(200,240,160,0.05); border-color: rgba(200,240,160,0.25); color: var(--accent); }

.action-btn {
  width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.10);
  border-radius: 7px; color: #777; font-family: var(--font-mono); font-size: 11px;
  padding: 10px; cursor: none; transition: all 0.15s; margin-bottom: 6px; letter-spacing: 0.04em;
}
.action-btn:hover { border-color: rgba(255,255,255,0.14); color: #ccc; }
.action-btn.dim { color: #444; }
.action-btn.dim:hover { color: #888; }

/* Color scheme picker — 3×3 grid */
.scheme-options {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 7px;
}
.scheme-btn {
  display: flex; align-items: center; gap: 8px;
  padding: 9px 12px; background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.09); border-radius: 8px;
  color: #777; font-family: var(--font-mono); font-size: 10px;
  cursor: none; transition: all 0.15s; letter-spacing: 0.04em;
}
.scheme-btn:hover { border-color: rgba(255,255,255,0.16); color: #bbb; background: rgba(255,255,255,0.06); }
.scheme-btn.active {
  border-color: var(--c);
  background: rgba(255,255,255,0.05);
  color: var(--c);
  box-shadow: 0 0 12px color-mix(in srgb, var(--c) 22%, transparent);
}
.scheme-dot {
  width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  transition: transform 0.15s; flex-shrink: 0;
}
.scheme-btn:hover .scheme-dot { transform: scale(1.2); }
.scheme-btn.active .scheme-dot { transform: scale(1.15); }


/* ── MUSIC APP ── */
#screen-music { padding: 0; align-items: stretch; justify-content: flex-start; }
.music-app {
  display: flex; width: 100%; height: 100%; padding-bottom: 60px;
  opacity: 0; transition: opacity 0.4s ease;
}
.music-app.ready { opacity: 1; }
.music-sidebar {
  width: 270px; flex-shrink: 0; display: flex; flex-direction: column;
  border-right: 1px solid rgba(255,255,255,0.06);
  background: rgba(3,3,5,0.7); backdrop-filter: blur(20px);
}
.music-sidebar-top { padding: 14px 12px 0; }
.music-search-wrap-inner {
  display: flex; align-items: center; gap: 9px;
  background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.10);
  border-radius: 8px; padding: 8px 12px; transition: border-color 0.2s, box-shadow 0.2s;
}
.music-search-wrap-inner:focus-within {
  border-color: rgba(var(--accent-rgb),0.35);
  box-shadow: 0 0 0 2px rgba(var(--accent-rgb),0.07);
}
.music-search-input-inner {
  flex: 1; background: none; border: none; outline: none;
  color: var(--text); font-family: var(--font-mono); font-size: 11px;
}
.music-search-input-inner::placeholder { color: #444; }
.music-sidebar-tabs { display: flex; gap: 2px; padding: 10px 12px 6px; }
.music-tab {
  flex: 1; background: none; border: none; color: #555; font-family: var(--font-mono);
  font-size: 10px; letter-spacing: 0.06em; padding: 6px; cursor: none;
  border-radius: 6px; transition: all 0.15s;
}
.music-tab:hover { color: #aaa; background: rgba(255,255,255,0.04); }
.music-tab.active { color: var(--accent); background: rgba(var(--accent-rgb),0.07); }
.music-tab-panel { display: none; flex: 1; overflow: hidden; flex-direction: column; }
.music-tab-panel.active { display: flex; }
.music-results, .music-queue-list {
  flex: 1; overflow-y: auto; padding: 4px 6px 8px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.05) transparent;
}
.music-results-empty { font-size: 11px; color: #333; text-align: center; padding: 40px 0; letter-spacing: 0.06em; }
.music-result-row {
  display: flex; align-items: center; gap: 10px; padding: 6px 8px;
  border-radius: 7px; cursor: none; transition: background 0.12s; position: relative;
}
.music-result-row:hover { background: rgba(255,255,255,0.05); }
.music-result-row.playing { background: rgba(var(--accent-rgb),0.07); }
.music-result-thumb { width: 36px; height: 36px; border-radius: 5px; object-fit: cover; flex-shrink: 0; background: var(--surface2); }
.music-result-info { flex: 1; min-width: 0; }
.music-result-name { font-size: 11px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; letter-spacing: 0.02em; }
.music-result-row.playing .music-result-name { color: var(--accent); }
.music-result-sub { font-size: 10px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; letter-spacing: 0.03em; }
.music-result-dur { font-size: 10px; color: #3a3a3a; flex-shrink: 0; letter-spacing: 0.04em; }
.music-result-add {
  background: none; border: none; color: #3a3a3a; font-size: 16px; cursor: none;
  padding: 3px 5px; line-height: 1; border-radius: 5px; transition: all 0.12s; flex-shrink: 0; opacity: 0;
}
.music-result-row:hover .music-result-add { opacity: 1; }
.music-result-add:hover { color: var(--accent); background: rgba(var(--accent-rgb),0.1); }
.music-center {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 20px 40px; position: relative; overflow: hidden;
}
.music-art-wrap { position: relative; width: 210px; height: 210px; flex-shrink: 0; margin-bottom: 26px; }
.music-art-bg {
  position: absolute; inset: -80px; border-radius: 50%;
  background-size: cover; background-position: center;
  filter: blur(70px) saturate(1.6); opacity: 0; transition: opacity 1.4s ease; z-index: 0; pointer-events: none;
}
.music-art-bg.on { opacity: 0.3; }
.music-art {
  position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
  border-radius: 16px; z-index: 1; opacity: 0; transition: opacity 0.5s ease;
  box-shadow: 0 24px 64px rgba(0,0,0,0.7), 0 4px 16px rgba(0,0,0,0.4);
}
.music-art.on { opacity: 1; }
.music-art-placeholder {
  position: absolute; inset: 0; z-index: 1; display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.025); border: 1px solid rgba(255,255,255,0.06);
  border-radius: 16px; transition: opacity 0.3s;
}
.music-art-placeholder.hidden { opacity: 0; pointer-events: none; }
.music-track-info { text-align: center; margin-bottom: 22px; width: 100%; max-width: 340px; }
.music-track-title { font-family: var(--font-display); font-size: 1.4rem; color: var(--text); letter-spacing: -0.01em; line-height: 1.2; margin-bottom: 7px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.music-track-artist { font-size: 12px; color: #666; letter-spacing: 0.05em; }
.music-controls { display: flex; align-items: center; gap: 4px; margin-bottom: 18px; }
.music-ctrl-btn {
  background: none; border: none; color: #555; cursor: none; padding: 9px;
  border-radius: 10px; transition: all 0.14s; display: flex; align-items: center; justify-content: center;
}
.music-ctrl-btn svg { width: 18px; height: 18px; }
.music-ctrl-btn:hover { color: #ddd; background: rgba(255,255,255,0.06); }
.music-ctrl-btn.on { color: var(--accent); }
.music-ctrl-play {
  width: 52px; height: 52px; border-radius: 50%;
  background: rgba(var(--accent-rgb),0.1) !important; border: 1px solid rgba(var(--accent-rgb),0.22) !important;
  color: var(--accent) !important; box-shadow: 0 0 24px rgba(var(--accent-rgb),0.08); transition: all 0.14s !important;
}
.music-ctrl-play:hover { background: rgba(var(--accent-rgb),0.18) !important; box-shadow: 0 0 36px rgba(var(--accent-rgb),0.18) !important; transform: scale(1.06); }
.music-ctrl-play svg { width: 22px; height: 22px; }
.music-progress-wrap { display: flex; align-items: center; gap: 10px; width: 100%; max-width: 360px; margin-bottom: 12px; }
.music-time { font-size: 10px; color: #3a3a3a; letter-spacing: 0.06em; flex-shrink: 0; min-width: 30px; }
.music-progress-bar {
  flex: 1; height: 3px; background: rgba(255,255,255,0.07); border-radius: 99px;
  position: relative; cursor: none; transition: height 0.15s;
}
.music-progress-bar:hover { height: 5px; }
.music-progress-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--accent); border-radius: 99px; width: 0%; pointer-events: none; }
.music-progress-thumb {
  position: absolute; top: 50%; transform: translate(-50%,-50%); width: 11px; height: 11px;
  border-radius: 50%; background: var(--accent); left: 0%; opacity: 0; transition: opacity 0.15s; pointer-events: none;
  box-shadow: 0 0 8px rgba(var(--accent-rgb),0.6);
}
.music-progress-bar:hover .music-progress-thumb { opacity: 1; }
.music-volume-wrap { display: flex; align-items: center; gap: 9px; width: 150px; }
.music-volume-bar { flex: 1; height: 3px; background: rgba(255,255,255,0.07); border-radius: 99px; position: relative; cursor: none; }
.music-volume-fill { position: absolute; left: 0; top: 0; height: 100%; background: rgba(255,255,255,0.25); border-radius: 99px; pointer-events: none; }
.music-volume-thumb { position: absolute; top: 50%; transform: translate(-50%,-50%); width: 9px; height: 9px; border-radius: 50%; background: rgba(255,255,255,0.55); pointer-events: none; }
.music-right {
  width: 240px; flex-shrink: 0; display: flex; flex-direction: column;
  border-left: 1px solid rgba(255,255,255,0.06); background: rgba(3,3,5,0.7); backdrop-filter: blur(20px);
}
.music-right-title { padding: 16px 14px 10px; flex-shrink: 0; font-size: 9px; color: #444; letter-spacing: 0.14em; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.04); }
.music-right-list { flex: 1; overflow-y: auto; padding: 6px 6px 8px; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.05) transparent; }
/* ── PLACEHOLDER APPS ── */
.placeholder-screen {
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px;
  padding-bottom: 60px;
}
.placeholder-screen svg { opacity: 0.15; }
.placeholder-label { font-size: 11px; color: #555; letter-spacing: 0.12em; }
.placeholder-sub { font-size: 10px; color: #444; letter-spacing: 0.08em; }

/* ── TASKBAR ── */
#taskbar {
  position: fixed; bottom: 18px; left: 50%;
  transform: translateX(-50%) translateY(0);
  z-index: 100;
  display: flex; align-items: center; gap: 4px;
  background: rgba(10,10,14,0.88); backdrop-filter: blur(28px);
  border: 1px solid rgba(255,255,255,0.11);
  border-top-color: rgba(255,255,255,0.17);
  border-radius: 18px; padding: 6px 8px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.03) inset, 0 1px 0 rgba(255,255,255,0.07) inset;
  opacity: 0; animation: taskbarIn 0.7s ease forwards 0.8s;
}
@keyframes taskbarIn {
  from { opacity: 0; transform: translateX(-50%) translateY(12px); }
  to   { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.taskbar-btn {
  display: flex; align-items: center; justify-content: center;
  width: 40px; height: 40px; border-radius: 12px;
  background: none; border: none; cursor: none;
  transition: all 0.15s; position: relative;
  color: #666;
}
.taskbar-btn:hover { background: rgba(255,255,255,0.07); color: #bbb; }
.taskbar-btn.active {
  background: rgba(var(--accent-rgb),0.1);
  color: var(--accent);
  box-shadow: 0 0 14px rgba(var(--accent-rgb),0.12);
}
.taskbar-btn svg { width: 18px; height: 18px; }

/* Active dot under taskbar icon */
.taskbar-btn.active::after {
  content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%);
  width: 4px; height: 4px; border-radius: 50%; background: var(--accent);
  box-shadow: 0 0 6px rgba(var(--accent-rgb),0.7);
}

.taskbar-sep {
  width: 1px; height: 24px; background: rgba(255,255,255,0.08); margin: 0 4px;
}

/* ── TOAST ── */
#toastContainer {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
  z-index: 9000; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none;
}
.toast {
  display: flex; align-items: center; gap: 8px; padding: 8px 14px;
  background: rgba(8,8,11,0.92); border: 1px solid rgba(255,255,255,0.05);
  border-top-color: rgba(255,255,255,0.08); border-radius: 8px;
  color: #666; font-family: var(--font-mono); font-size: 11px; letter-spacing: 0.04em;
  backdrop-filter: blur(20px); white-space: nowrap;
  opacity: 0; transform: translateY(6px); transition: opacity 0.2s, transform 0.2s;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast-dot { width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; }
.toast.info .toast-dot { background: rgba(200,240,160,0.6); }
.toast.info { color: #888; border-color: rgba(200,240,160,0.08); }
.toast.success .toast-dot { background: var(--accent); box-shadow: 0 0 6px rgba(200,240,160,0.5); }
.toast.success { border-color: rgba(200,240,160,0.18); color: var(--accent); }
.toast.error .toast-dot { background: #f87171; }
.toast.error { border-color: rgba(248,113,113,0.15); color: #f87171; }
</style>
</head>
<body>

<canvas id="bg"></canvas>
<div id="grain-overlay"></div>
<div class="vignette"></div>
<div class="cursor-glow" id="cursorGlow"></div>
<div class="cursor-dot" id="cursorDot"></div>
<div class="panic-flash" id="panicFlash"></div>

<div id="toastContainer"></div>

<!-- ══ HOME SCREEN ══ -->
<div class="screen active" id="screen-home">
  <div class="wordmark">oblivion</div>
  <div class="tagline">between here and nowhere</div>
  <div class="app-grid">

    <div class="app-icon" data-screen="browser">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="15" cy="15" r="11"/>
          <path d="M4 15h22M15 4c-3 4-4.5 7-4.5 11s1.5 7 4.5 11M15 4c3 4 4.5 7 4.5 11s-1.5 7-4.5 11"/>
        </svg>
      </div>
      <span class="icon-label">browser</span>
    </div>

    <div class="app-icon" data-screen="games">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="9" width="24" height="16" rx="4"/>
          <path d="M9 17v-3m0 0v-3m0 3H6m3 0h3"/>
          <circle cx="21" cy="14" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <circle cx="24" cy="17" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <circle cx="18" cy="17" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <circle cx="21" cy="20" r="1.2" fill="rgba(255,255,255,0.35)" stroke="none"/>
          <path d="M10 6l2 3M20 6l-2 3" stroke-width="1.2"/>
        </svg>
      </div>
      <span class="icon-label">games</span>
    </div>

    <div class="app-icon" data-screen="music">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 22V8l14-3v14"/>
          <circle cx="8" cy="22" r="3"/>
          <circle cx="22" cy="19" r="3"/>
        </svg>
      </div>
      <span class="icon-label">music</span>
    </div>

    <div class="app-icon" data-screen="account">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="15" cy="11" r="5"/>
          <path d="M4 26c0-5 5-8 11-8s11 3 11 8"/>
        </svg>
      </div>
      <span class="icon-label">account</span>
    </div>

    <div class="app-icon" data-screen="settings">
      <div class="icon-tile">
        <svg viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 8h22M4 15h22M4 22h22"/>
          <circle cx="10" cy="8" r="3" fill="rgba(5,5,7,1)" stroke="rgba(255,255,255,0.35)"/>
          <circle cx="20" cy="15" r="3" fill="rgba(5,5,7,1)" stroke="rgba(255,255,255,0.35)"/>
          <circle cx="10" cy="22" r="3" fill="rgba(5,5,7,1)" stroke="rgba(255,255,255,0.35)"/>
        </svg>
      </div>
      <span class="icon-label">settings</span>
    </div>

  </div>
</div>

<!-- ══ BROWSER SCREEN ══ -->
<div class="screen" id="screen-browser">
  <div class="browser-bar">
    <div class="browser-tabs" id="browserTabs">
      <button class="browser-tab-new" id="newTabBtn" title="new tab">+</button>
    </div>
  </div>
  <div class="browser-addr-row">
    <button class="browser-nav-btn" id="navBack" title="back">←</button>
    <button class="browser-nav-btn" id="navForward" title="forward">→</button>
    <button class="browser-nav-btn" id="navRefresh" title="refresh">↺</button>
    <div class="browser-addr-wrap">
      <input class="browser-addr" id="browserAddr" placeholder="search or enter url..." autocomplete="off" spellcheck="false">
      <button class="browser-go" id="browserGo">go</button>
    </div>
    <select class="engine-select" id="engineSelect">
      <option value="https://duckduckgo.com/?q=">DuckDuckGo</option>
      <option value="https://www.google.com/search?q=">Google</option>
      <option value="https://search.brave.com/search?q=">Brave</option>
      <option value="https://www.bing.com/search?q=">Bing</option>
      <option value="https://search.yahoo.com/search?p=">Yahoo</option>
    </select>
  </div>
  <div class="browser-frames" id="browserFrames"></div>
</div>

<!-- ══ GAMES SCREEN ══ -->
<div class="screen" id="screen-games">
  <div class="games-header">
    <div class="games-header-title">games</div>
    <input class="games-search" id="gamesSearch" placeholder="search..." autocomplete="off" spellcheck="false">
    <select class="games-sort-sel" id="gamesSort">
      <option value="name">a–z</option>
      <option value="popular">popular</option>
      <option value="newest">newest</option>
    </select>
  </div>
  <div class="games-scroll">
    <div class="games-grid" id="gamesGrid">
      <div class="games-loading">loading games...</div>
    </div>
  </div>
</div>

<!-- Game viewer overlay -->
<div class="game-viewer" id="gameViewer">
  <div class="game-viewer-bar">
    <div class="game-viewer-title" id="gameViewerTitle">game</div>
    <div class="game-viewer-author" id="gameViewerAuthor"></div>
    <button class="gv-btn" id="gameFullscreen">⛶ fullscreen</button>
    <button class="gv-btn" id="gameNewTab">↗ new tab</button>
    <button class="gv-btn" id="gameClose">✕ close</button>
  </div>
  <iframe id="gameFrame" sandbox="allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-popups allow-modals" allowfullscreen></iframe>
</div>

<!-- ══ MUSIC SCREEN ══ -->
<div class="screen" id="screen-music">
  <div class="music-app" id="musicApp">
    <div class="music-sidebar">
      <div class="music-sidebar-top">
        <div class="music-search-wrap-inner">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" style="width:13px;height:13px;flex-shrink:0;color:#555;"><circle cx="6.5" cy="6.5" r="4"/><path d="M11 11l3 3"/></svg>
          <input class="music-search-input-inner" id="musicSearch" placeholder="songs, artists, albums..." autocomplete="off" spellcheck="false">
        </div>
      </div>
      <div class="music-sidebar-tabs">
        <button class="music-tab active" data-mtab="search">search</button>
        <button class="music-tab" data-mtab="queue">queue</button>
      </div>
      <div class="music-tab-panel active" id="mtab-search">
        <div class="music-results" id="musicResults"><div class="music-results-empty">search for a song</div></div>
      </div>
      <div class="music-tab-panel" id="mtab-queue">
        <div class="music-queue-list" id="musicQueueList"><div class="music-results-empty">queue is empty</div></div>
      </div>
    </div>
    <div class="music-center">
      <div class="music-art-wrap">
        <div class="music-art-bg" id="musicArtBg"></div>
        <img class="music-art" id="musicArt" src="" alt="">
        <div class="music-art-placeholder" id="musicArtPlaceholder">
          <svg viewBox="0 0 48 48" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1.2" stroke-linecap="round"><path d="M19 35V17l22-5v18"/><circle cx="14" cy="35" r="5"/><circle cx="36" cy="30" r="5"/></svg>
        </div>
      </div>
      <div class="music-track-info">
        <div class="music-track-title" id="musicTrackTitle">nothing playing</div>
        <div class="music-track-artist" id="musicTrackArtist">—</div>
      </div>
      <div class="music-controls">
        <button class="music-ctrl-btn" id="musicShuffle" title="shuffle">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h2l9 6h3M14 7h3v2.5M14 13h3v-2.5M3 13h2"/><path d="M17 7l-1.5 1.5M17 13l-1.5-1.5" stroke-width="1.2"/></svg>
        </button>
        <button class="music-ctrl-btn" id="musicPrev" title="previous">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4v12M15 4L8 10l7 6V4z"/></svg>
        </button>
        <button class="music-ctrl-btn music-ctrl-play" id="musicPlay" title="play/pause">
          <svg id="musicPlayIcon" viewBox="0 0 20 20" fill="currentColor"><path d="M6 4l11 6-11 6V4z"/></svg>
        </button>
        <button class="music-ctrl-btn" id="musicNext" title="next">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 4v12M5 4l7 6-7 6V4z"/></svg>
        </button>
        <button class="music-ctrl-btn" id="musicRepeat" title="repeat">
          <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h12v3l3-3-3-3v3M16 13H4v-3l-3 3 3 3v-3"/></svg>
        </button>
      </div>
      <div class="music-progress-wrap">
        <span class="music-time" id="musicCurrentTime">0:00</span>
        <div class="music-progress-bar" id="musicProgressBar">
          <div class="music-progress-fill" id="musicProgressFill"></div>
          <div class="music-progress-thumb" id="musicProgressThumb"></div>
        </div>
        <span class="music-time" id="musicDuration">0:00</span>
      </div>
      <div class="music-volume-wrap">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" style="width:13px;height:13px;flex-shrink:0;color:#555;"><path d="M2 5h3l4-3v12l-4-3H2V5zM11 5.5a4 4 0 010 5M13 3a7 7 0 010 10"/></svg>
        <div class="music-volume-bar" id="musicVolumeBar">
          <div class="music-volume-fill" id="musicVolumeFill" style="width:80%"></div>
          <div class="music-volume-thumb" id="musicVolumeThumb" style="left:80%"></div>
        </div>
      </div>
    </div>
    <div class="music-right">
      <div class="music-right-title" id="musicRightTitle">recently played</div>
      <div class="music-right-list" id="musicRightList"><div class="music-results-empty">play a song to see history</div></div>
    </div>
  </div>
</div>

<!-- ══ ACCOUNT SCREEN (placeholder) ══ -->
<div class="screen placeholder-screen" id="screen-account">
  <svg width="64" height="64" viewBox="0 0 30 30" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1.2" stroke-linecap="round">
    <circle cx="15" cy="11" r="5"/><path d="M4 26c0-5 5-8 11-8s11 3 11 8"/>
  </svg>
  <div class="placeholder-label">account</div>
  <div class="placeholder-sub">coming soon</div>
</div>

<!-- ══ SETTINGS SCREEN ══ -->
<div class="screen" id="screen-settings">
  <div class="settings-inner">
    <div class="settings-app-title">settings</div>

    <div class="settings-section">
      <div class="settings-section-title">background</div>
      <div class="bg-options" id="bgOptions">
        <div class="bg-option" data-bg="particles" id="prev-particles">
          <canvas id="prev-canvas-particles"></canvas>
          <div class="bg-option-label">particles</div>
        </div>
        <div class="bg-option" data-bg="rain" id="prev-rain">
          <canvas id="prev-canvas-rain"></canvas>
          <div class="bg-option-label">rain</div>
        </div>
        <div class="bg-option" data-bg="matrix" id="prev-matrix">
          <canvas id="prev-canvas-matrix"></canvas>
          <div class="bg-option-label">matrix</div>
        </div>
        <div class="bg-option" data-bg="starfield" id="prev-starfield">
          <canvas id="prev-canvas-starfield"></canvas>
          <div class="bg-option-label">starfield</div>
        </div>
        <div class="bg-option" data-bg="dots" id="prev-dots">
          <canvas id="prev-canvas-dots"></canvas>
          <div class="bg-option-label">dots</div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">panic key</div>
      <div class="panic-row">
        <div class="panic-key-display" id="panicKeyDisplay">?</div>
        <button class="panic-set-btn" id="panicSetBtn">press to set key</button>
        <span class="panic-hint">instantly navigates away<br>and clears history</span>
      </div>
      <div class="cloak-label" style="margin-top:10px;">escape url</div>
      <div class="input-row">
        <input id="panicUrl" type="text" placeholder="https://clever.com" autocomplete="off" spellcheck="false">
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">tab cloak</div>
      <div class="cloak-label">tab name</div>
      <div class="input-row"><input id="cloakTitle" type="text" placeholder="e.g. Google Classroom" autocomplete="off" spellcheck="false"></div>
      <div class="cloak-label">favicon preset</div>
      <div class="cloak-presets" id="cloakPresets">
        <button class="cloak-preset" data-title="Google Classroom" data-icon="https://ssl.gstatic.com/classroom/favicon.png"><img src="https://ssl.gstatic.com/classroom/favicon.png" alt=""> classroom</button>
        <button class="cloak-preset" data-title="Google Docs" data-icon="https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico"><img src="https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico" alt=""> docs</button>
        <button class="cloak-preset" data-title="Google Drive" data-icon="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png"><img src="https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" alt=""> drive</button>
        <button class="cloak-preset" data-title="Khan Academy" data-icon="/favicons/khan.ico"><img src="/favicons/khan.ico" alt=""> khan</button>
        <button class="cloak-preset" data-title="Quizlet" data-icon="/favicons/quizlet.ico"><img src="/favicons/quizlet.ico" alt=""> quizlet</button>
        <button class="cloak-preset" data-title="Duolingo" data-icon="/favicons/duolingo.ico"><img src="/favicons/duolingo.ico" alt=""> duolingo</button>
        <button class="cloak-preset" data-title="Desmos" data-icon="/favicons/desmos.ico"><img src="/favicons/desmos.ico" alt=""> desmos</button>
        <button class="cloak-preset" data-title="Clever | Portal" data-icon="/favicons/clever.ico"><img src="/favicons/clever.ico" alt=""> clever</button>
        <button class="cloak-preset" data-title="Choose a subject, i-Ready" data-icon="/favicons/iready.ico"><img src="/favicons/iready.ico" alt=""> i-ready</button>
        <button class="cloak-preset" data-title="NoodleTools - Projects" data-icon="/favicons/noodletools.ico"><img src="/favicons/noodletools.ico" alt=""> noodle</button>
        <button class="cloak-preset" data-title="Schoology" data-icon="/favicons/schoology.ico"><img src="/favicons/schoology.ico" alt=""> schoology</button>
        <button class="cloak-preset active" data-title="oblivion" data-icon="/void-icon.svg"><img src="/void-icon.svg" alt=""> oblivion</button>
      </div>
      <div class="cloak-label">custom icon url</div>
      <div class="input-row"><input id="cloakIcon" type="text" placeholder="https://example.com/favicon.ico" autocomplete="off" spellcheck="false"></div>
      <button class="action-btn" id="applyCloak">apply cloak</button>
      <button class="action-btn dim" id="resetCloak">reset to oblivion</button>
    </div>

    <div class="settings-section">
      <div class="settings-section-title">color scheme</div>
      <div class="scheme-options" id="schemeOptions"></div>
    </div>



    <div class="settings-section">
      <div class="settings-section-title">about</div>
      <div style="font-size:11px;color:#555;line-height:1.8;letter-spacing:0.04em;">
        oblivion — between here and nowhere<br>
        <a href="https://discord.gg/gmb2RegMTd" target="_blank" style="color:#666;text-decoration:none;transition:color 0.15s;cursor:none;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='#666'">discord ↗</a>
      </div>
    </div>

  </div>
</div>

<!-- ══ TASKBAR ══ -->
<div id="taskbar">
  <button class="taskbar-btn active" data-screen="home" title="home">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 9.5L10 3l7 6.5V17a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/>
      <path d="M7 18v-6h6v6"/>
    </svg>
  </button>
  <div class="taskbar-sep"></div>
  <button class="taskbar-btn" data-screen="browser" title="browser">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="10" cy="10" r="8"/>
      <path d="M2 10h16M10 2c-2 3-3 5-3 8s1 5 3 8M10 2c2 3 3 5 3 8s-1 5-3 8"/>
    </svg>
  </button>
  <button class="taskbar-btn" data-screen="games" title="games">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <rect x="2" y="6" width="16" height="11" rx="3"/>
      <path d="M6 11.5v-2m0 0v-2m0 2H4m2 0h2"/>
      <circle cx="14" cy="9.5" r="0.8" fill="currentColor" stroke="none"/>
      <circle cx="16" cy="11.5" r="0.8" fill="currentColor" stroke="none"/>
      <circle cx="12" cy="11.5" r="0.8" fill="currentColor" stroke="none"/>
      <circle cx="14" cy="13.5" r="0.8" fill="currentColor" stroke="none"/>
    </svg>
  </button>
  <button class="taskbar-btn" data-screen="music" title="music">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <path d="M7 15.5V5.5l10-2v10"/>
      <circle cx="5" cy="15.5" r="2"/><circle cx="15" cy="13.5" r="2"/>
    </svg>
  </button>
  <button class="taskbar-btn" data-screen="account" title="account">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="10" cy="7" r="3.5"/>
      <path d="M2 18c0-4 3.5-6 8-6s8 2 8 6"/>
    </svg>
  </button>
  <div class="taskbar-sep"></div>
  <button class="taskbar-btn" data-screen="settings" title="settings">
    <svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 5h14M3 10h14M3 15h14"/>
      <circle cx="7" cy="5" r="2" fill="var(--bg)" stroke="currentColor"/>
      <circle cx="13" cy="10" r="2" fill="var(--bg)" stroke="currentColor"/>
      <circle cx="7" cy="15" r="2" fill="var(--bg)" stroke="currentColor"/>
    </svg>
  </button>
</div>

<script src="/scram/scramjet.all.js"></script>
<script src="/register-sw.js"></script>
<script type="module">
import { BareMuxConnection } from '/baremux/index.mjs';

const { ScramjetController } = $scramjetLoadController();
const scramjet = new ScramjetController({
  files: { wasm: '/scram/scramjet.wasm.wasm', all: '/scram/scramjet.all.js', sync: '/scram/scramjet.sync.js' },
});
scramjet.init('/sw.js');
const connection = new BareMuxConnection('/baremux/worker.js');

// ── TOAST ──────────────────────────────────────────────────────────────
function toast(msg, type = 'info', duration = 3000) {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span class="toast-dot"></span>${msg}`;
  document.getElementById('toastContainer').appendChild(el);
  requestAnimationFrame(() => requestAnimationFrame(() => el.classList.add('show')));
  setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 220); }, duration);
}
(async () => {
  try {
    toast('scramjet initializing...', 'info', 2000);
    await navigator.serviceWorker.register('/sw.js');
    setTimeout(() => toast('scramjet ready', 'success', 2500), 800);
  } catch(e) { toast('scramjet failed to initialize', 'error', 4000); }
})();

// ── BACKGROUND ─────────────────────────────────────────────────────────
const canvas = document.getElementById('bg');
const ctx = canvas.getContext('2d');
let W, H, bgAnimId = null;
const mouse = { x: -9999, y: -9999 };
let currentBg = localStorage.getItem('oblivionBg') || 'rain';

function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
window.addEventListener('resize', () => { resize(); startBg(currentBg); });
window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
window.addEventListener('mouseleave', () => { mouse.x = -9999; mouse.y = -9999; });
resize();

// particles
let particles=[], tick=0, trail=[], trailIndex=0;
const TRAIL_LENGTH=20;
function initParticles(){
  tick=0; trailIndex=0;
  trail = Array.from({length:TRAIL_LENGTH},()=>({x:-9999,y:-9999}));
  particles = Array.from({length:Math.floor((W*H)/7000)},()=>({
    x:Math.random()*W, y:Math.random()*H, vx:(Math.random()-0.5)*0.4, vy:(Math.random()-0.5)*0.4,
    r:Math.random()*1.8+0.4, alpha:Math.random()*0.35+0.08, connections:[]
  }));
}
function drawParticles(){
  tick++; ctx.clearRect(0,0,W,H);
  trail[trailIndex]={x:mouse.x,y:mouse.y}; trailIndex=(trailIndex+1)%TRAIL_LENGTH;
  for(let i=0;i<TRAIL_LENGTH;i++){
    const idx=(trailIndex-1-i+TRAIL_LENGTH)%TRAIL_LENGTH;
    const t=trail[idx]; if(t.x===-9999)continue;
    const a=(1-i/TRAIL_LENGTH)*0.18;
    ctx.beginPath(); ctx.arc(t.x,t.y,(1-i/TRAIL_LENGTH)*2.5,0,Math.PI*2);
    ctx.fillStyle=`rgba(200,240,160,${a})`; ctx.fill();
  }
  for(let p of particles){
    if(mouse.x!==-9999){const dx=mouse.x-p.x,dy=mouse.y-p.y,d=Math.sqrt(dx*dx+dy*dy);if(d<100&&d>0){p.vx-=(dx/d)*0.06;p.vy-=(dy/d)*0.06;}}
    p.vx*=0.99;p.vy*=0.99;p.x+=p.vx;p.y+=p.vy;
    if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;
  }
  for(let i=0;i<particles.length;i++){
    for(let j=i+1;j<particles.length;j++){
      const dx=particles[i].x-particles[j].x,dy=particles[i].y-particles[j].y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<100){ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);ctx.lineTo(particles[j].x,particles[j].y);ctx.strokeStyle=`rgba(200,240,160,${(1-d/100)*0.12})`;ctx.lineWidth=0.6;ctx.stroke();}
    }
    ctx.beginPath();ctx.arc(particles[i].x,particles[i].y,particles[i].r,0,Math.PI*2);
    ctx.fillStyle=`rgba(200,240,160,${particles[i].alpha})`;ctx.fill();
  }
  bgAnimId=requestAnimationFrame(drawParticles);
}

// rain
let rainDrops=[],splashes=[];
function initRain(){
  splashes=[];
  const cols=Math.floor(W/9);
  rainDrops=Array.from({length:cols},()=>({
    x:Math.random()*W, y:Math.random()*-H,
    speed:Math.random()*4+3.5,
    len:Math.random()*18+8,
    op:Math.random()*0.28+0.06,
    w:Math.random()*0.6+0.2,
    wind:(Math.random()-0.3)*0.6  // mostly slight right lean, some variation
  }));
}
function drawRain(){
  ctx.clearRect(0,0,W,H);
  for(let d of rainDrops){
    const dropH = d.len * 10;
    const dropX = d.wind * dropH;
    const g=ctx.createLinearGradient(d.x - dropX, d.y - dropH, d.x, d.y);
    g.addColorStop(0,'rgba(180,200,255,0)');
    g.addColorStop(0.6,`rgba(200,215,255,${d.op * 0.5})`);
    g.addColorStop(1,`rgba(215,225,255,${d.op})`);
    ctx.beginPath(); ctx.moveTo(d.x - dropX, d.y - dropH); ctx.lineTo(d.x, d.y);
    ctx.strokeStyle=g; ctx.lineWidth=d.w; ctx.stroke();
    d.x += d.wind * 0.8; d.y += d.speed * 5.5;
    if(d.y > H + 20){
      if(Math.random()<0.12) splashes.push({x:d.x,y:H-2,vx:(Math.random()-0.5)*1.5,vy:-Math.random()*1.5-0.5,life:1,decay:0.08});
      d.y = Math.random() * -H * 0.5;
      d.x = Math.random() * W;
      d.speed = Math.random()*4+3.5;
      d.op = Math.random()*0.28+0.06;
    }
  }
  for(let i=splashes.length-1;i>=0;i--){
    const s=splashes[i];
    ctx.beginPath();ctx.arc(s.x,s.y,1.2*s.life,0,Math.PI*2);
    ctx.fillStyle=`rgba(200,215,255,${s.life*0.3})`;ctx.fill();
    s.x+=s.vx;s.y+=s.vy;s.vy+=0.1;s.life-=s.decay;
    if(s.life<=0)splashes.splice(i,1);
  }
  bgAnimId=requestAnimationFrame(drawRain);
}
window.addEventListener('click',e=>{if(currentBg==='rain'){for(let i=0;i<12;i++)splashes.push({x:e.clientX,y:e.clientY,vx:(Math.random()-0.5)*4,vy:-Math.random()*3-1,life:1,decay:0.04});}});

// matrix
let matrixCols=[],matrixTick=0;
const MATRIX_CHARS='ｦｧｨｩｪｫｬｭｮｯｰｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝ0123456789';const MATRIX_FS=13;
function initMatrix(){matrixTick=0;const cols=Math.floor(W/MATRIX_FS);matrixCols=Array.from({length:cols},()=>{const len=Math.floor(Math.random()*28+10);return{x:0,y:-(Math.random()*H),speed:Math.random()*0.4+0.15,chars:Array.from({length:len},()=>MATRIX_CHARS[Math.floor(Math.random()*MATRIX_CHARS.length)]),charTimer:0,charInterval:Math.floor(Math.random()*8+4),alpha:Math.random()*0.25+0.05};});}
function drawMatrix(){
  matrixTick++;ctx.fillStyle='rgba(5,5,7,0.18)';ctx.fillRect(0,0,W,H);
  for(let i=0;i<matrixCols.length;i++){
    const col=matrixCols[i];col.x=i*MATRIX_FS;
    let dist=99999;if(mouse.x!==-9999){const dx=col.x-mouse.x;dist=Math.abs(dx);}
    const proximity=Math.max(0,1-dist/180);const speed=col.speed*(1+proximity*3);const baseAlpha=col.alpha*(1+proximity*2);
    col.charTimer++;if(col.charTimer>=col.charInterval){col.charTimer=0;if(Math.random()<0.3)col.chars[Math.floor(Math.random()*col.chars.length)]=MATRIX_CHARS[Math.floor(Math.random()*MATRIX_CHARS.length)];}
    for(let j=0;j<col.chars.length;j++){
      const cy=col.y+j*MATRIX_FS;if(cy<0||cy>H)continue;
      const isHead=j===col.chars.length-1;
      if(isHead){ctx.fillStyle=`rgba(220,255,220,${baseAlpha*3})`;ctx.font=`bold ${MATRIX_FS}px monospace`;}
      else{const fade=1-j/col.chars.length;ctx.fillStyle=`rgba(100,${Math.floor(160+proximity*80)},80,${fade*baseAlpha})`;ctx.font=`${MATRIX_FS}px monospace`;}
      ctx.fillText(col.chars[j],col.x,cy);
    }
    col.y+=speed*MATRIX_FS*0.3;if(col.y>H)col.y=-col.chars.length*MATRIX_FS;
  }
  bgAnimId=requestAnimationFrame(drawMatrix);
}

// starfield
let stars=[],shootingStars=[],warpParticles=[],starTick=0;
function initStarfield(){starTick=0;shootingStars=[];warpParticles=[];stars=Array.from({length:320},()=>({x:Math.random()*W,y:Math.random()*H,z:Math.random(),size:Math.random()*1.6+0.2,bright:Math.random(),twinkle:Math.random()*Math.PI*2,twinkleSpeed:Math.random()*0.025+0.005,color:Math.random()>0.85?[255,220,180]:Math.random()>0.7?[180,200,255]:[215,215,235]}));}
function drawStarfield(){
  starTick++;ctx.clearRect(0,0,W,H);
  if(mouse.x!==-9999){const r=W*0.42;const g=ctx.createRadialGradient(mouse.x,mouse.y,0,mouse.x,mouse.y,r);g.addColorStop(0,'rgba(18,12,35,0.09)');g.addColorStop(0.4,'rgba(14,10,28,0.05)');g.addColorStop(0.75,'rgba(8,6,16,0.02)');g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.fillRect(0,0,W,H);}
  const ox=mouse.x===-9999?0:(mouse.x-W/2)*0.018,oy=mouse.y===-9999?0:(mouse.y-H/2)*0.018;
  if(starTick%280===0&&Math.random()<0.6)shootingStars.push({x:Math.random()*W*0.7,y:Math.random()*H*0.4,vx:Math.random()*6+4,vy:Math.random()*3+1.5,life:1,decay:0.018,len:Math.floor(Math.random()*60+30)});
  for(let s of stars){s.twinkle+=s.twinkleSpeed;const tw=0.55+Math.sin(s.twinkle)*0.45;const px=s.x+ox*s.z,py=s.y+oy*s.z;const alpha=(0.25+s.bright*0.55)*tw;const r=s.size*(0.4+s.bright*0.7);if(s.bright>0.75){ctx.shadowBlur=4+s.bright*6;ctx.shadowColor=`rgba(${s.color[0]},${s.color[1]},${s.color[2]},${alpha*0.6})`;}ctx.beginPath();ctx.arc(px,py,r,0,Math.PI*2);ctx.fillStyle=`rgba(${s.color[0]},${s.color[1]},${s.color[2]},${alpha})`;ctx.fill();ctx.shadowBlur=0;}
  for(let i=shootingStars.length-1;i>=0;i--){const ss=shootingStars[i];const g=ctx.createLinearGradient(ss.x-ss.vx*ss.len/6,ss.y-ss.vy*ss.len/6,ss.x,ss.y);g.addColorStop(0,'rgba(210,220,255,0)');g.addColorStop(1,`rgba(230,235,255,${ss.life*0.8})`);ctx.beginPath();ctx.moveTo(ss.x-ss.vx*ss.len/6,ss.y-ss.vy*ss.len/6);ctx.lineTo(ss.x,ss.y);ctx.strokeStyle=g;ctx.lineWidth=ss.life*1.5;ctx.stroke();ss.x+=ss.vx;ss.y+=ss.vy;ss.life-=ss.decay;if(ss.life<=0)shootingStars.splice(i,1);}
  for(let i=warpParticles.length-1;i>=0;i--){const p=warpParticles[i];ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);ctx.fillStyle=`rgba(${p.color[0]},${p.color[1]},${p.color[2]},${p.life*0.7})`;ctx.fill();p.x+=p.vx;p.y+=p.vy;p.life-=p.decay;if(p.life<=0)warpParticles.splice(i,1);}
  bgAnimId=requestAnimationFrame(drawStarfield);
}
window.addEventListener('click',e=>{if(currentBg==='starfield'){for(let i=0;i<60;i++){const angle=Math.random()*Math.PI*2,speed=Math.random()*5+1;warpParticles.push({x:e.clientX,y:e.clientY,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:1,decay:Math.random()*0.025+0.01,r:Math.random()*1.5+0.3,color:Math.random()>0.5?[200,210,255]:[255,240,200]});}}});

// dot grid
let dotGrid=[],dotTick=0;const DOT_SPACING=28;
function initDotGrid(){dotTick=0;dotGrid=[];const cols=Math.ceil(W/DOT_SPACING)+1,rows=Math.ceil(H/DOT_SPACING)+1;for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)dotGrid.push({bx:c*DOT_SPACING,by:r*DOT_SPACING,x:c*DOT_SPACING,y:r*DOT_SPACING,baseR:Math.random()*0.8+0.6,phase:Math.random()*Math.PI*2,phaseSpeed:Math.random()*0.004+0.001,baseAlpha:Math.random()*0.12+0.06});}
function drawDotGrid(){
  dotTick++;ctx.clearRect(0,0,W,H);const waveTime=dotTick*0.012;
  for(let d of dotGrid){
    d.phase+=d.phaseSpeed;const breathe=Math.sin(d.phase)*0.3;
    const waveOffset=Math.sin(d.bx*0.022+waveTime)*11+Math.sin(d.bx*0.011-waveTime*0.7)*5+Math.sin(d.by*0.018+waveTime*0.5)*4;
    let tx=d.bx,ty=d.by+waveOffset,extraR=0,extraAlpha=0,greenTint=0;
    if(mouse.x!==-9999){const dx=d.bx-mouse.x,dy=d.by-mouse.y,dist=Math.sqrt(dx*dx+dy*dy);if(dist<220&&dist>0){const force=Math.pow(1-dist/220,2.2);tx=d.bx+(dx/dist)*force*52;ty=d.by+waveOffset+(dy/dist)*force*52;extraR=force*5.5;extraAlpha=force*0.7;greenTint=force;}}
    d.x+=(tx-d.x)*0.14;d.y+=(ty-d.y)*0.14;
    const r=d.baseR+extraR+breathe,alpha=d.baseAlpha+extraAlpha;
    if(greenTint>0.1){const g=Math.floor(170+greenTint*70),gb=Math.floor(80+greenTint*80);ctx.fillStyle=`rgba(${Math.floor(180+greenTint*40)},${g},${gb},${alpha})`;}
    else ctx.fillStyle=`rgba(180,185,195,${alpha})`;
    ctx.beginPath();ctx.arc(d.x,d.y,Math.max(0.1,r),0,Math.PI*2);ctx.fill();
  }
  bgAnimId=requestAnimationFrame(drawDotGrid);
}

function startBg(name){
  if(bgAnimId)cancelAnimationFrame(bgAnimId);bgAnimId=null;ctx.clearRect(0,0,W,H);
  currentBg=name;localStorage.setItem('oblivionBg',name);
  if(name==='particles'){initParticles();drawParticles();}
  else if(name==='rain'){initRain();drawRain();}
  else if(name==='matrix'){initMatrix();drawMatrix();}
  else if(name==='starfield'){initStarfield();drawStarfield();}
  else if(name==='dots'){initDotGrid();drawDotGrid();}
  document.querySelectorAll('.bg-option').forEach(o=>o.classList.toggle('active',o.dataset.bg===name));
}
startBg(currentBg);

// preview thumbnails
function drawPreview(type,c){
  const pc=document.getElementById(`prev-canvas-${type}`);if(!pc)return;
  const pctx=pc.getContext('2d');const pw=pc.offsetWidth,ph=pc.offsetHeight;
  pc.width=pw;pc.height=ph;pctx.clearRect(0,0,pw,ph);
  if(type==='particles'){for(let i=0;i<18;i++){const x=Math.random()*pw,y=Math.random()*ph;pctx.beginPath();pctx.arc(x,y,Math.random()*1.5+0.3,0,Math.PI*2);pctx.fillStyle=`rgba(200,240,160,${Math.random()*0.5+0.1})`;pctx.fill();}
  }else if(type==='rain'){for(let i=0;i<24;i++){const x=Math.random()*pw,y=Math.random()*ph,l=Math.random()*12+6;const g=pctx.createLinearGradient(x-2,y-l,x,y);g.addColorStop(0,'rgba(200,215,255,0)');g.addColorStop(1,`rgba(210,220,255,${Math.random()*0.4+0.1})`);pctx.beginPath();pctx.moveTo(x-2,y-l);pctx.lineTo(x,y);pctx.strokeStyle=g;pctx.lineWidth=0.5;pctx.stroke();}
  }else if(type==='matrix'){for(let i=0;i<8;i++){for(let j=0;j<5;j++){pctx.fillStyle=`rgba(100,200,80,${Math.random()*0.3+0.05})`;pctx.font='6px monospace';pctx.fillText(MATRIX_CHARS[Math.floor(Math.random()*MATRIX_CHARS.length)],i*8+2,j*10+8);}}
  }else if(type==='starfield'){for(let i=0;i<30;i++){pctx.beginPath();pctx.arc(Math.random()*pw,Math.random()*ph,Math.random()*1.2+0.2,0,Math.PI*2);pctx.fillStyle=`rgba(215,215,235,${Math.random()*0.6+0.1})`;pctx.fill();}
  }else if(type==='dots'){const sp=8;for(let x=sp;x<pw;x+=sp)for(let y=sp;y<ph;y+=sp){pctx.beginPath();pctx.arc(x,y,0.8,0,Math.PI*2);pctx.fillStyle=`rgba(180,185,195,${Math.random()*0.15+0.05})`;pctx.fill();}}
}
setTimeout(()=>['particles','rain','matrix','starfield','dots'].forEach(t=>drawPreview(t)),300);
document.querySelectorAll('.bg-option').forEach(o=>o.addEventListener('click',()=>startBg(o.dataset.bg)));

// ── SCREEN NAVIGATION ──────────────────────────────────────────────────
let currentScreen = 'home';
function navigate(screenId) {
  if (screenId === currentScreen) return;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(`screen-${screenId}`);
  if (target) { target.classList.add('active'); currentScreen = screenId; }
  document.querySelectorAll('.taskbar-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.screen === screenId || (screenId !== 'home' && b.dataset.screen === screenId));
  });
  // update home button separately
  document.querySelector('.taskbar-btn[data-screen="home"]').classList.toggle('active', screenId === 'home');
}

document.querySelectorAll('.app-icon').forEach(icon => {
  icon.addEventListener('click', () => navigate(icon.dataset.screen));
});
document.querySelectorAll('.taskbar-btn').forEach(btn => {
  btn.addEventListener('click', () => navigate(btn.dataset.screen));
});

// ── BROWSER ────────────────────────────────────────────────────────────
let tabs = [], activeTabId = null, tabCounter = 0;

function createTab(url = null) {
  const id = ++tabCounter;
  const frame = document.createElement('div');
  frame.className = 'browser-frame-slot';
  frame.id = `frame-${id}`;
  document.getElementById('browserFrames').appendChild(frame);

  if (url) {
    const iframe = document.createElement('iframe');
    iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-pointer-lock allow-popups';
    iframe.allowFullscreen = true;
    frame.appendChild(iframe);
  } else {
    const _shortcuts = [
      { label: 'youtube', url: 'https://youtube.com', icon: '<path d="M15.8 7.6a2 2 0 00-1.4-1.4C13.2 6 10 6 10 6s-3.2 0-4.4.2A2 2 0 004.2 7.6C4 8.8 4 10 4 10s0 1.2.2 2.4a2 2 0 001.4 1.4C6.8 14 10 14 10 14s3.2 0 4.4-.2a2 2 0 001.4-1.4C16 11.2 16 10 16 10s0-1.2-.2-2.4zM8.5 12V8l3.5 2-3.5 2z" fill="rgba(255,255,255,0.6)"/>' },
      { label: 'google', url: 'https://google.com', icon: '<text x="10" y="14" text-anchor="middle" font-size="13" fill="rgba(255,255,255,0.6)" font-family="Arial,sans-serif" font-weight="700">G</text>' },
      { label: 'reddit', url: 'https://reddit.com', icon: '<circle cx="10" cy="10.5" r="5.5" fill="rgba(255,255,255,0.6)"/><circle cx="8" cy="11" r="1" fill="#222"/><circle cx="12" cy="11" r="1" fill="#222"/><path d="M8 13q2 1.2 4 0" stroke="#222" stroke-width="0.8" fill="none" stroke-linecap="round"/><circle cx="10" cy="5.5" r="1.2" fill="rgba(255,255,255,0.6)"/><path d="M10 6.7v2.3" stroke="rgba(255,255,255,0.6)" stroke-width="1"/>' },
      { label: 'discord', url: 'https://discord.com', icon: '<path d="M13.5 5A10 10 0 007 4a10 10 0 00-5 1.2S1 7 1 9.5s.8 3 .8 3L3.5 14l.8-1.5h11.4l.8 1.5 1.7-1.5s.8-.5.8-3S15 5.2 15 5.2A10 10 0 0013.5 5zM6.5 11a1.3 1.3 0 110-2.6 1.3 1.3 0 010 2.6zm7 0a1.3 1.3 0 110-2.6 1.3 1.3 0 010 2.6z" fill="rgba(255,255,255,0.6)" transform="scale(0.9) translate(1,1)"/>' },
      { label: 'twitch', url: 'https://twitch.tv', icon: '<path d="M3 2L2 5v10h4v2h2.5L11 15h3l4-4V2H3zm12 8l-3 3H9L7 15v-2H4V4h11v6z" fill="rgba(255,255,255,0.6)" transform="scale(0.85) translate(1.5,1)"/><rect x="9.5" y="6.5" width="1.5" height="3.5" fill="rgba(255,255,255,0.6)" transform="scale(0.85) translate(1.5,1)"/><rect x="13" y="6.5" width="1.5" height="3.5" fill="rgba(255,255,255,0.6)" transform="scale(0.85) translate(1.5,1)"/>' },
    ];
    const _scHtml = _shortcuts.map(s =>
      `<div class="newtab-shortcut" data-url="${s.url}"><div class="newtab-shortcut-icon"><svg viewBox="0 0 20 20" width="22" height="22">${s.icon}</svg></div><span class="newtab-shortcut-label">${s.label}</span></div>`
    ).join('');
    frame.innerHTML = `<div class="newtab-page">
      <div class="newtab-wordmark" id="newtab-wm-${id}">oblivion</div>
      <div class="newtab-search-wrap" id="newtab-sw-${id}">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" width="15" height="15"><circle cx="6.5" cy="6.5" r="4.5"/><path d="M11 11l3 3"/></svg>
        <input class="newtab-search-input" id="newtab-si-${id}" placeholder="search the web..." autocomplete="off" spellcheck="false">
        <button class="newtab-search-go">go</button>
      </div>
      <div class="newtab-shortcuts">${_scHtml}</div>
      <div class="newtab-hint" id="newtab-hint-${id}">oblivion browser</div>
    </div>`;
    const _ntIn = frame.querySelector('#newtab-si-' + id);
    const _ntGo = frame.querySelector('.newtab-search-go');
    const _doSearch = () => {
      const v = _ntIn.value.trim(); if (!v) return;
      // Put value in address bar so browserNavigate can pick it up as fallback
      document.getElementById('browserAddr').value = v;
      browserNavigate(v.startsWith('http') ? v : v.includes('.') && !v.includes(' ') ? 'https://' + v : null, v);
    };
    _ntIn.addEventListener('keydown', e => { if (e.key === 'Enter') _doSearch(); });
    _ntGo.addEventListener('click', _doSearch);
    frame.querySelectorAll('.newtab-shortcut').forEach(s => s.addEventListener('click', () => browserNavigate(s.dataset.url)));
  }

  const tab = { id, url, title: url ? (()=>{ try{ return new URL(url.startsWith('http')?url:'https://'+url).hostname; }catch(e){ return url.slice(0,20); } })() : 'new tab', frame };
  tabs.push(tab);
  renderTabs(id); // pass id so renderTabs applies entering animation
  setActiveTab(id);
  return tab;
}

function renderTabs(enteringId = null) {
  const container = document.getElementById('browserTabs');
  const newBtn = document.getElementById('newTabBtn');
  container.querySelectorAll('.browser-tab').forEach(el => el.remove());
  tabs.forEach(tab => {
    const el = document.createElement('div');
    el.className = 'browser-tab' + (tab.id === activeTabId ? ' active' : '');
    el.dataset.tabId = tab.id;
    el.innerHTML = `<span class="browser-tab-title">${tab.title}</span><button class="browser-tab-close" data-id="${tab.id}">×</button>`;
    el.addEventListener('click', e => { if (!e.target.classList.contains('browser-tab-close')) setActiveTab(tab.id); });
    el.querySelector('.browser-tab-close').addEventListener('click', e => { e.stopPropagation(); closeTab(tab.id); });
    container.insertBefore(el, newBtn);
    if (tab.id === enteringId) {
      el.classList.add('tab-entering');
      el.addEventListener('animationend', () => el.classList.remove('tab-entering'), { once: true });
    }
  });
}

function setActiveTab(id) {
  activeTabId = id;
  tabs.forEach(t => { t.frame.classList.toggle('active', t.id === id); });
  const tab = tabs.find(t => t.id === id);
  if (tab) document.getElementById('browserAddr').value = tab.url || '';
  // Just update active class — don't rebuild DOM
  document.querySelectorAll('.browser-tab').forEach(el => {
    el.classList.toggle('active', parseInt(el.dataset.tabId) === id);
  });
}

function closeTab(id) {
  const idx = tabs.findIndex(t => t.id === id);
  const tab = tabs[idx];
  const el = document.querySelector(`.browser-tab[data-tab-id="${id}"]`);
  const doClose = () => {
    tab.frame.remove();
    tabs.splice(idx, 1);
    if (tabs.length === 0) createTab();
    else if (activeTabId === id) setActiveTab(tabs[Math.min(idx, tabs.length-1)].id);
    else renderTabs();
  };
  if (el) {
    el.classList.add('tab-leaving');
    el.addEventListener('animationend', doClose, { once: true });
  } else {
    doClose();
  }
}

async function browserNavigate(url, rawQuery) {
  let val = url || document.getElementById('browserAddr').value.trim();
  if (!val) return;
  if (!val.startsWith('http://') && !val.startsWith('https://')) {
    const _q = rawQuery || val;
    val = val.includes('.') && !val.includes(' ')
      ? 'https://' + val
      : document.getElementById('engineSelect').value + encodeURIComponent(_q);
  }
  const tab = tabs.find(t => t.id === activeTabId);
  if (!tab) return;

  try {
    await navigator.serviceWorker.register('/sw.js');
    const wispUrl = (location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/wisp/';
    if ((await connection.getTransport()) !== '/libcurl/index.mjs') {
      toast('connecting...', 'info', 1500);
      await connection.setTransport('/libcurl/index.mjs', [{ websocket: wispUrl }]);
    }
    tab.frame.innerHTML = '';
    const sjFrame = scramjet.createFrame();
    sjFrame.frame.style.cssText = 'width:100%;height:100%;border:none;';
    tab.frame.appendChild(sjFrame.frame);
    sjFrame.go(val);
    tab.url = val;
    try { tab.title = new URL(val).hostname; } catch(e) { tab.title = val.slice(0,20); }
    document.getElementById('browserAddr').value = val;
    renderTabs();
    toast('navigating...', 'info', 1200);
  } catch(e) {
    toast('navigation failed', 'error', 3000);
  }
}

document.getElementById('browserGo').addEventListener('click', () => browserNavigate());
document.getElementById('browserAddr').addEventListener('keydown', e => { if(e.key==='Enter') browserNavigate(); });

// Redirect address bar focus to newtab search bar when on an empty tab
document.getElementById('browserAddr').addEventListener('focus', e => {
  const tab = tabs.find(t => t.id === activeTabId);
  if (!tab || tab.url) return;
  const ntIn = tab.frame.querySelector('.newtab-search-input');
  if (ntIn) { setTimeout(() => ntIn.focus(), 0); e.target.blur(); }
});
document.getElementById('newTabBtn').addEventListener('click', () => { navigate('browser'); createTab(); });
document.getElementById('navBack').addEventListener('click', () => { const f = tabs.find(t=>t.id===activeTabId)?.frame.querySelector('iframe'); if(f) try{f.contentWindow.history.back();}catch(e){} });
document.getElementById('navForward').addEventListener('click', () => { const f = tabs.find(t=>t.id===activeTabId)?.frame.querySelector('iframe'); if(f) try{f.contentWindow.history.forward();}catch(e){} });
document.getElementById('navRefresh').addEventListener('click', () => { const tab = tabs.find(t=>t.id===activeTabId); if(tab?.url) browserNavigate(tab.url); });

// Create initial tab
createTab();

// ── GAMES ──────────────────────────────────────────────────────────────
const COVER_URL = 'https://cdn.jsdelivr.net/gh/gn-math/covers@main';
const HTML_URL = 'https://cdn.jsdelivr.net/gh/gn-math/html@main';
let allZones = [], popularityData = {};

function sortZones(zones, by) {
  if (by==='name') return [...zones].sort((a,b)=>a.name.localeCompare(b.name));
  if (by==='popular') return [...zones].sort((a,b)=>(popularityData[b.id]||0)-(popularityData[a.id]||0));
  if (by==='newest') return [...zones].sort((a,b)=>b.id-a.id);
  return zones;
}

async function loadGames() {
  try {
    const res = await fetch('https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json?t='+Date.now());
    const raw = await res.json();
    allZones = raw.filter(z => !z.name.startsWith('[!]'));
    try {
      const popRes = await fetch('https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year');
      const popData = await popRes.json();
      const files = Array.isArray(popData) ? popData : (popData.files || []);
      files.forEach(f => { const m = f.name?.match(/\/(\d+)\.html$/); if(m) popularityData[parseInt(m[1])] = f.hits?.total || f.hits || 0; });
    } catch(e) {}
    renderGames(allZones);
  } catch(e) {
    document.getElementById('gamesGrid').innerHTML = '<div class="games-loading">failed to load games</div>';
  }
}

function renderGames(zones) {
  const grid = document.getElementById('gamesGrid');
  const sortBy = document.getElementById('gamesSort').value;
  const sorted = sortZones(zones, sortBy);
  grid.classList.add('fading');
  setTimeout(() => {
    grid.innerHTML = '';
    if (!sorted.length) { grid.innerHTML = '<div class="games-loading">no games found</div>'; grid.classList.remove('fading'); return; }
    sorted.forEach(zone => {
      const card = document.createElement('div');
      card.className = 'game-card';
      card.addEventListener('click', () => openGame(zone));
      const img = document.createElement('img');
      img.loading = 'lazy'; img.alt = zone.name;
      img.src = zone.cover.replace('{COVER_URL}', COVER_URL).replace('{HTML_URL}', HTML_URL);
      const name = document.createElement('div');
      name.className = 'game-card-name'; name.textContent = zone.name;
      card.appendChild(img); card.appendChild(name);
      grid.appendChild(card);
    });
    grid.classList.remove('fading');
  }, 180);
}

async function openGame(zone) {
  document.getElementById('gameViewerTitle').textContent = zone.name;
  document.getElementById('gameViewerAuthor').textContent = zone.author ? 'by '+zone.author : '';
  const viewer = document.getElementById('gameViewer');
  const frame = document.getElementById('gameFrame');
  viewer.classList.add('open');
  if (zone.url.startsWith('http')) {
    frame.src = zone.url;
  } else {
    frame.src = zone.url.replace('{HTML_URL}', HTML_URL).replace('{COVER_URL}', COVER_URL);
  }
}

document.getElementById('gameClose').addEventListener('click', () => {
  document.getElementById('gameViewer').classList.remove('open');
  document.getElementById('gameFrame').src = '';
});
document.getElementById('gameFullscreen').addEventListener('click', () => {
  document.getElementById('gameFrame').requestFullscreen?.();
});
document.getElementById('gameNewTab').addEventListener('click', () => {
  window.open(document.getElementById('gameFrame').src, '_blank');
});

document.getElementById('gamesSearch').addEventListener('input', e => {
  const q = e.target.value.toLowerCase();
  renderGames(q ? allZones.filter(z => z.name.toLowerCase().includes(q)) : allZones);
});
document.getElementById('gamesSort').addEventListener('change', () => {
  const q = document.getElementById('gamesSearch').value.toLowerCase();
  renderGames(q ? allZones.filter(z => z.name.toLowerCase().includes(q)) : allZones);
});

loadGames();

// ── CURSOR ─────────────────────────────────────────────────────────────
const glowEl = document.getElementById('cursorGlow');
const dotEl = document.getElementById('cursorDot');
let glowPos = { x: -9999, y: -9999 };

function animCursor() {
  glowPos.x += (mouse.x - glowPos.x) * 0.55;
  glowPos.y += (mouse.y - glowPos.y) * 0.55;
  glowEl.style.left = glowPos.x + 'px'; glowEl.style.top = glowPos.y + 'px';
  dotEl.style.left = mouse.x + 'px'; dotEl.style.top = mouse.y + 'px';
  requestAnimationFrame(animCursor);
}
animCursor();
window.addEventListener('mousemove', e => {
  glowEl.style.opacity = '1';
  const activeTag = document.activeElement?.tagName;
  const hoverTag = e.target?.tagName;
  const isTyping = activeTag === 'INPUT' || activeTag === 'TEXTAREA' || hoverTag === 'INPUT' || hoverTag === 'TEXTAREA';
  dotEl.style.opacity = isTyping ? '0' : '1';
  trailDots.forEach(d => { d.el.style.opacity = isTyping ? '0' : ''; });
});
window.addEventListener('mouseleave', () => { glowEl.style.opacity = '0'; dotEl.style.opacity = '0'; });
document.addEventListener('focusin', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    dotEl.style.opacity = '0';
    trailDots.forEach(d => { d.el.style.opacity = '0'; });
  }
});
document.addEventListener('focusout', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
    dotEl.style.opacity = '1';
    trailVisible = true;
  }
});

// Trail
const TRAIL_COUNT = 20;
const trailDots = Array.from({ length: TRAIL_COUNT }, (_, i) => {
  const el = document.createElement('div');
  el.className = 'cursor-trail';
  const size = Math.max(2, 7 - i * 0.28);
  el.style.cssText = `width:${size}px;height:${size}px;opacity:0;`;
  document.body.appendChild(el);
  return { el, x: -9999, y: -9999 };
});
let trailVisible = false;
function animTrail() {
  // High lerp values = trail sticks close to real cursor
  trailDots[0].x += (mouse.x - trailDots[0].x) * 0.88;
  trailDots[0].y += (mouse.y - trailDots[0].y) * 0.88;
  for (let i = 1; i < TRAIL_COUNT; i++) {
    trailDots[i].x += (trailDots[i-1].x - trailDots[i].x) * 0.72;
    trailDots[i].y += (trailDots[i-1].y - trailDots[i].y) * 0.72;
  }
  trailDots.forEach((d, i) => {
    const size = Math.max(2, 7 - i * 0.28);
    d.el.style.width = size + 'px';
    d.el.style.height = size + 'px';
    d.el.style.left = d.x + 'px';
    d.el.style.top = d.y + 'px';
    d.el.style.opacity = trailVisible ? (1 - i / TRAIL_COUNT) * 0.9 : 0;
  });
  requestAnimationFrame(animTrail);
}
animTrail();
window.addEventListener('mousemove', () => { trailVisible = true; });
window.addEventListener('mouseleave', () => { trailVisible = false; });

// ── PANIC KEY ──────────────────────────────────────────────────────────
let panicKey = localStorage.getItem('oblivionPanicKey') || '';
let panicUrl = localStorage.getItem('oblivionPanicUrl') || 'https://clever.com';
let settingPanic = false;
const panicKeyDisplay = document.getElementById('panicKeyDisplay');
const panicSetBtn = document.getElementById('panicSetBtn');
const panicUrlInput = document.getElementById('panicUrl');
panicKeyDisplay.textContent = panicKey || '?';
panicUrlInput.value = panicUrl;
panicSetBtn.addEventListener('click', () => { settingPanic = true; panicSetBtn.textContent = 'listening...'; });
panicUrlInput.addEventListener('change', () => { panicUrl = panicUrlInput.value.trim(); localStorage.setItem('oblivionPanicUrl', panicUrl); });
window.addEventListener('keydown', e => {
  if (settingPanic) { panicKey = e.key; localStorage.setItem('oblivionPanicKey', panicKey); panicKeyDisplay.textContent = panicKey; panicSetBtn.textContent = 'press to set key'; settingPanic = false; return; }
  if (panicKey && e.key === panicKey) {
    const flash = document.getElementById('panicFlash'); flash.style.opacity = '1';
    setTimeout(() => { const url = panicUrl.startsWith('http') ? panicUrl : 'https://'+panicUrl; window.location.replace(url); }, 80);
  }
});

// ── CLOAK ──────────────────────────────────────────────────────────────
let currentCloakIcon = '/void-icon.svg';
function setFavicon(url) {
  let link = document.querySelector("link[rel~='icon']");
  if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
  link.href = url;
}
const savedTitle = localStorage.getItem('oblivionCloakTitle');
const savedIcon = localStorage.getItem('oblivionCloakIcon');
if (savedTitle) document.title = savedTitle;
if (savedIcon) { setFavicon(savedIcon); currentCloakIcon = savedIcon; }

document.querySelectorAll('.cloak-preset').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.cloak-preset').forEach(b => b.classList.remove('active'));
    btn.classList.add('active'); currentCloakIcon = btn.dataset.icon;
    document.getElementById('cloakTitle').value = btn.dataset.title;
    document.getElementById('cloakIcon').value = '';
  });
});
document.getElementById('cloakIcon').addEventListener('input', e => { if(e.target.value.trim()){ document.querySelectorAll('.cloak-preset').forEach(b=>b.classList.remove('active')); currentCloakIcon=e.target.value.trim(); }});
document.getElementById('applyCloak').addEventListener('click', () => {
  const title = document.getElementById('cloakTitle').value.trim();
  const icon = document.getElementById('cloakIcon').value.trim() || currentCloakIcon;
  if (title) { document.title = title; localStorage.setItem('oblivionCloakTitle', title); }
  if (icon) { setFavicon(icon); localStorage.setItem('oblivionCloakIcon', icon); }
  const btn = document.getElementById('applyCloak'); btn.textContent = 'applied ✓';
  setTimeout(() => btn.textContent = 'apply cloak', 1500);
});
// ── COLOR SCHEME ───────────────────────────────────────────────────────
// ── COLOR SCHEMES ─────────────────────────────────────────────────────
const SCHEMES = [
  { id:'midnight', name:'midnight', accent:'#c8f0a0', rgb:'200,240,160', bg:'#020204', s1:'#07070a', s2:'#0d0d11' },
  { id:'aurora',   name:'aurora',   accent:'#7dd3fc', rgb:'125,211,252', bg:'#010308', s1:'#03060f', s2:'#070d1a' },
  { id:'dusk',     name:'dusk',     accent:'#c4b5fd', rgb:'196,181,253', bg:'#030208', s1:'#07050f', s2:'#0e0a1a' },
  { id:'ember',    name:'ember',    accent:'#fbbf24', rgb:'251,191,36',  bg:'#060300', s1:'#0e0700', s2:'#180e00' },
  { id:'rose',     name:'rose',     accent:'#f9a8d4', rgb:'249,168,212', bg:'#060204', s1:'#0f0508', s2:'#190a10' },
  { id:'glacial',  name:'glacial',  accent:'#67e8f9', rgb:'103,232,249', bg:'#010507', s1:'#030d10', s2:'#07141e' },
  { id:'crimson',  name:'crimson',  accent:'#fca5a5', rgb:'252,165,165', bg:'#060101', s1:'#0f0404', s2:'#190808' },
  { id:'void',     name:'void',     accent:'#a78bfa', rgb:'167,139,250', bg:'#020108', s1:'#06030f', s2:'#0d071c' },
  { id:'ash',      name:'ash',      accent:'#d4d4d8', rgb:'212,212,216', bg:'#020202', s1:'#080808', s2:'#0f0f0f' },
];

// Inject CSS for all schemes
const schemeStyle = document.createElement('style');
schemeStyle.textContent = SCHEMES.map(s =>
  s.id === 'midnight' ? '' :
  `body.scheme-${s.id}{--accent:${s.accent};--accent-rgb:${s.rgb};--bg:${s.bg};--surface:${s.s1};--surface2:${s.s2};}`
).join('\n');
document.head.appendChild(schemeStyle);

// Build scheme grid
const schemeGrid = document.getElementById('schemeOptions');
SCHEMES.forEach(s => {
  const btn = document.createElement('button');
  btn.className = 'scheme-btn';
  btn.dataset.scheme = s.id;
  btn.style.setProperty('--c', s.accent);
  btn.innerHTML = `<span class="scheme-dot" style="background:${s.accent};box-shadow:0 0 6px ${s.accent}88"></span>${s.name}`;
  btn.addEventListener('click', () => applyScheme(s.id));
  schemeGrid.appendChild(btn);
});

const savedScheme = localStorage.getItem('oblivionScheme') || 'midnight';
function applyScheme(name) {
  document.body.className = document.body.className.replace(/scheme-\S+/g, '').trim();
  if (name !== 'midnight') document.body.classList.add('scheme-' + name);
  localStorage.setItem('oblivionScheme', name);
  document.querySelectorAll('.scheme-btn').forEach(b => b.classList.toggle('active', b.dataset.scheme === name));
}
applyScheme(savedScheme);

document.getElementById('resetCloak').addEventListener('click', () => {
  document.title = 'oblivion'; setFavicon('/void-icon.svg');
  localStorage.removeItem('oblivionCloakTitle'); localStorage.removeItem('oblivionCloakIcon');
  document.getElementById('cloakTitle').value = ''; document.getElementById('cloakIcon').value = '';
  document.querySelectorAll('.cloak-preset').forEach(b => b.classList.remove('active'));
  document.querySelector('.cloak-preset[data-title="oblivion"]').classList.add('active');
  currentCloakIcon = '/void-icon.svg';
});

// ── MUSIC ────────────────────────────────────────────────────────────────
// Plain <audio> element approach — no YouTube IFrame API, no COEP issues.
// ── MUSIC ───────────────────────────────────────────────────────────────
// Audio via saavn.dev — free JioSaavn API, direct mp3 URLs, no auth needed.
// Search returns track name, artist, duration, album art, and downloadUrl.

let audioEl = null;          // the <audio> element
let musicQueue = [], musicQueueIdx = -1, currentTrack = null;
let musicPlaying = false, musicShuffleOn = false, musicRepeatOn = false;
let musicVol = 80, progressDragging = false, progressTimer = null;
let _playingId = null;

function getAudio() {
  if (!audioEl) {
    audioEl = new Audio();
    audioEl.crossOrigin = 'anonymous';
    audioEl.volume = musicVol / 100;
    audioEl.addEventListener('play',  () => { musicPlaying = true;  updatePlayBtn(); startTimer(); });
    audioEl.addEventListener('pause', () => { musicPlaying = false; updatePlayBtn(); });
    audioEl.addEventListener('ended', () => {
      musicPlaying = false; updatePlayBtn();
      if (musicRepeatOn) { audioEl.currentTime = 0; audioEl.play(); }
      else if (musicShuffleOn && musicQueue.length > 1) {
        musicQueueIdx = Math.floor(Math.random() * musicQueue.length);
        playTrack(musicQueue[musicQueueIdx]);
      } else if (musicQueueIdx < musicQueue.length - 1) {
        musicQueueIdx++; playTrack(musicQueue[musicQueueIdx]);
      }
    });
    audioEl.addEventListener('error', e => {
      console.error('[audio] error', audioEl.error);
      toast('playback error — try another track', 'error', 3000);
    });
    audioEl.addEventListener('timeupdate', () => {
      if (progressDragging) return;
      const cur = audioEl.currentTime, dur = audioEl.duration || 0;
      if (dur > 0) {
        const pct = (cur / dur) * 100;
        document.getElementById('musicProgressFill').style.width = pct + '%';
        document.getElementById('musicProgressThumb').style.left = pct + '%';
        document.getElementById('musicCurrentTime').textContent = fmtTime(Math.floor(cur));
        document.getElementById('musicDuration').textContent = fmtTime(Math.floor(dur));
      }
    });
  }
  return audioEl;
}

async function saavnSearch(q) {
  const res = await fetch('/api/saavn?query=' + encodeURIComponent(q) + '&limit=20');
  const json = await res.json();
  if (!res.ok) throw new Error(json.error || 'saavn ' + res.status);
  // saavn.dev response shape: { data: { results: [...] } }
  // Each result has: id, name, artists.primary[], duration, image[], downloadUrl[]
  const results = json?.data?.results || [];
  return results.map(s => {
    const imgs = Array.isArray(s.image) ? s.image : [];
    const best = imgs[2] || imgs[1] || imgs[0];
    const imgUrl = best?.url || best?.link || '';
    const dlUrls = Array.isArray(s.downloadUrl) ? s.downloadUrl : [];
    // highest quality last in array (320kbps)
    let audioUrl = null;
    for (let i = dlUrls.length - 1; i >= 0; i--) {
      if (dlUrls[i]?.url) { audioUrl = dlUrls[i].url; break; }
    }
    const artistName = s.artists?.primary?.[0]?.name
      || (Array.isArray(s.artists?.primary) ? '' : '')
      || s.primaryArtists || '';
    return {
      id: s.id,
      name: s.name,
      artist: artistName,
      duration_ms: (s.duration || 0) * 1000,
      image: imgUrl ? '/api/img/' + imgUrl.replace('https://', '') : '',
      audioUrl,
      _source: 'saavn'
    };
  });
}

// ── Recently played ──────────────────────────────────────────────────
let recentlyPlayed = [];
function addToRecent(track) {
  recentlyPlayed = recentlyPlayed.filter(t => t.id !== track.id);
  recentlyPlayed.unshift(track);
  if (recentlyPlayed.length > 30) recentlyPlayed.pop();
  renderTrackList(document.getElementById('musicRightList'), recentlyPlayed, false);
}
function loadFeatured() {
  document.getElementById('musicRightList').innerHTML = '<div class="music-results-empty">play a song to see history</div>';
}

// ── Search ───────────────────────────────────────────────────────────
let searchTimer = null;
document.getElementById('musicSearch').addEventListener('input', e => {
  clearTimeout(searchTimer);
  const q = e.target.value.trim();
  const el = document.getElementById('musicResults');
  if (!q) { el.innerHTML = '<div class="music-results-empty">search for a song</div>'; return; }
  el.innerHTML = '<div class="music-results-empty">searching...</div>';
  searchTimer = setTimeout(async () => {
    try {
      const tracks = await saavnSearch(q);
      if (!tracks.length) { el.innerHTML = '<div class="music-results-empty">no results</div>'; return; }
      el.innerHTML = '';
      renderTrackList(el, tracks, true);
    } catch(err) {
      console.error('[music] search error:', err);
      el.innerHTML = '<div class="music-results-empty">search failed: ' + err.message + '</div>';
    }
  }, 350);
});

function renderTrackList(container, tracks, showAdd) {
  container.innerHTML = '';
  tracks.forEach(t => container.appendChild(makeRow(t, showAdd)));
}

function makeRow(track, showAdd) {
  const el = document.createElement('div');
  el.className = 'music-result-row' + (currentTrack?.id === track.id ? ' playing' : '');
  el.dataset.id = track.id;
  const thumb = track.image || '';
  const artist = track.artist || '';
  const dur = track.duration_ms ? fmtTime(Math.floor(track.duration_ms / 1000)) : '';
  el.innerHTML =
    (thumb
      ? '<img class="music-result-thumb" src="' + esc(thumb) + '" loading="lazy" alt="" onerror="this.style.opacity=0.2">'
      : '<div class="music-result-thumb" style="background:var(--surface2);border-radius:5px;"></div>') +
    '<div class="music-result-info">' +
      '<div class="music-result-name">' + esc(track.name) + '</div>' +
      '<div class="music-result-sub">' + esc(artist) + '</div>' +
    '</div>' +
    (dur ? '<span class="music-result-dur">' + dur + '</span>' : '') +
    (showAdd ? '<button class="music-result-add" title="add to queue">+</button>' : '');
  el.addEventListener('click', e => {
    if (e.target.classList.contains('music-result-add')) return;
    musicQueue.push(track); musicQueueIdx = musicQueue.length - 1;
    playTrack(track);
  });
  if (showAdd) {
    el.querySelector('.music-result-add').addEventListener('click', e => {
      e.stopPropagation(); musicQueue.push(track); renderQueue();
      toast('"' + track.name + '" added to queue', 'success', 1800);
    });
  }
  return el;
}

function renderQueue() {
  const el = document.getElementById('musicQueueList');
  el.innerHTML = '';
  if (!musicQueue.length) { el.innerHTML = '<div class="music-results-empty">queue is empty</div>'; return; }
  musicQueue.forEach((t, i) => {
    const row = makeRow(t, false);
    if (i === musicQueueIdx) row.classList.add('playing');
    el.appendChild(row);
  });
}

// ── Core playback ────────────────────────────────────────────────────
async function playTrack(track) {
  _playingId = track.id;
  currentTrack = track;
  addToRecent(track);

  // Update UI immediately
  document.getElementById('musicTrackTitle').textContent = track.name;
  document.getElementById('musicTrackArtist').textContent = track.artist || '';
  const artEl = document.getElementById('musicArt');
  const bgEl  = document.getElementById('musicArtBg');
  if (track.image) {
    artEl.src = track.image; artEl.classList.add('on');
    bgEl.style.backgroundImage = 'url(' + track.image + ')'; bgEl.classList.add('on');
    document.getElementById('musicArtPlaceholder').classList.remove('hidden');
    artEl.onload = () => document.getElementById('musicArtPlaceholder').classList.add('hidden');
  } else {
    artEl.src = ''; artEl.classList.remove('on');
    bgEl.style.backgroundImage = ''; bgEl.classList.remove('on');
    document.getElementById('musicArtPlaceholder').classList.remove('hidden');
  }
  document.querySelectorAll('.music-result-row').forEach(r =>
    r.classList.toggle('playing', r.dataset.id === track.id)
  );
  renderQueue();

  // saavn gives us a direct audio URL on the track object — no lookup needed
  const audioUrl = track.audioUrl;
  if (!audioUrl) {
    toast('no audio available for this track', 'error', 3000);
    return;
  }

  try {
    document.getElementById('toastContainer').innerHTML = '';
    toast('loading…', 'info', 4000);
    const audio = getAudio();
    audio.pause();
    audio.src = audioUrl;
    audio.volume = musicVol / 100;
    await audio.play();
    document.getElementById('toastContainer').innerHTML = '';
    musicPlaying = true;
    updatePlayBtn();
  } catch(e) {
    document.getElementById('toastContainer').innerHTML = '';
    toast('playback error: ' + e.message, 'error', 3000);
    console.error('[music] playback error:', e);
  }
}

// ── Controls ─────────────────────────────────────────────────────────
function updatePlayBtn() {
  document.getElementById('musicPlayIcon').innerHTML = musicPlaying
    ? '<rect x="5" y="4" width="4" height="12" rx="1" fill="currentColor"/><rect x="11" y="4" width="4" height="12" rx="1" fill="currentColor"/>'
    : '<path d="M6 4l11 6-11 6V4z"/>';
}

function startTimer() { /* handled by timeupdate event on audio element */ }

function makeDraggable(barId, fillId, thumbId, onVal) {
  const bar = document.getElementById(barId), fill = document.getElementById(fillId), thumb = document.getElementById(thumbId);
  let down = false;
  const calc = e => { const r = bar.getBoundingClientRect(); return Math.max(0, Math.min(1, (e.clientX - r.left) / r.width)); };
  bar.addEventListener('mousedown', e => { down = true; const v = calc(e); fill.style.width=(v*100)+'%'; if(thumb) thumb.style.left=(v*100)+'%'; onVal(v,true); });
  window.addEventListener('mousemove', e => { if(!down) return; const v=calc(e); fill.style.width=(v*100)+'%'; if(thumb) thumb.style.left=(v*100)+'%'; onVal(v,true); });
  window.addEventListener('mouseup',  e => { if(!down) return; down=false; const v=calc(e); fill.style.width=(v*100)+'%'; if(thumb) thumb.style.left=(v*100)+'%'; onVal(v,false); });
}

makeDraggable('musicProgressBar','musicProgressFill','musicProgressThumb', (v, drag) => {
  progressDragging = drag;
  if (!drag && audioEl) audioEl.currentTime = v * (audioEl.duration || 0);
});
makeDraggable('musicVolumeBar','musicVolumeFill','musicVolumeThumb', v => {
  musicVol = Math.round(v * 100);
  if (audioEl) audioEl.volume = musicVol / 100;
});

document.getElementById('musicPlay').addEventListener('click', () => {
  const a = getAudio();
  if (!a.src) return;
  musicPlaying ? a.pause() : a.play();
});
document.getElementById('musicNext').addEventListener('click', () => {
  if (musicShuffleOn && musicQueue.length > 1) { musicQueueIdx = Math.floor(Math.random() * musicQueue.length); playTrack(musicQueue[musicQueueIdx]); }
  else if (musicQueueIdx < musicQueue.length - 1) { musicQueueIdx++; playTrack(musicQueue[musicQueueIdx]); }
});
document.getElementById('musicPrev').addEventListener('click', () => {
  if (audioEl && audioEl.currentTime > 3) { audioEl.currentTime = 0; return; }
  if (musicQueueIdx > 0) { musicQueueIdx--; playTrack(musicQueue[musicQueueIdx]); }
});
document.getElementById('musicShuffle').addEventListener('click', () => {
  musicShuffleOn = !musicShuffleOn;
  document.getElementById('musicShuffle').classList.toggle('on', musicShuffleOn);
});
document.getElementById('musicRepeat').addEventListener('click', () => {
  musicRepeatOn = !musicRepeatOn;
  document.getElementById('musicRepeat').classList.toggle('on', musicRepeatOn);
});

document.querySelectorAll('.music-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.music-tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.music-tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('mtab-' + btn.dataset.mtab).classList.add('active');
  });
});

function fmtTime(s) { return Math.floor(s/60) + ':' + String(s%60).padStart(2,'0'); }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

let musicInited = false;
document.querySelectorAll('.taskbar-btn[data-screen="music"],.app-icon[data-screen="music"]').forEach(el => {
  el.addEventListener('click', () => {
    if (!musicInited) { musicInited = true; musicInit(); }
  }, true);
});

async function musicInit() {
  document.getElementById('musicApp').classList.add('ready');
  loadFeatured();
}

</script>
</body>
</html>
